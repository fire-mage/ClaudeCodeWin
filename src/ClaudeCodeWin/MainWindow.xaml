<Window x:Class="ClaudeCodeWin.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:converters="clr-namespace:ClaudeCodeWin.Converters"
        xmlns:vm="clr-namespace:ClaudeCodeWin.ViewModels"
        Title="ClaudeCodeWin"
        MinHeight="500" MinWidth="600"
        Background="{StaticResource BackgroundBrush}"
        AllowDrop="True"
        Drop="Window_Drop"
        DragOver="Window_DragOver"
        DragEnter="Window_DragEnter"
        DragLeave="Window_DragLeave"
        PreviewKeyDown="Window_PreviewKeyDown">

    <Window.Resources>
        <converters:BoolToVisibilityConverter x:Key="BoolToVis"/>
        <converters:InverseBoolConverter x:Key="InverseBool"/>
        <converters:RoleToAlignmentConverter x:Key="RoleToAlign"/>
        <converters:RoleToBubbleBrushConverter x:Key="RoleToBubble"/>
        <converters:RoleToMaxWidthConverter x:Key="RoleToMaxWidth"/>
        <converters:EditDiffLineTypeToBrushConverter x:Key="DiffLineBrush"/>
        <converters:GitStatusToBrushConverter x:Key="GitStatusBrush"/>
        <converters:StatusTextToBrushConverter x:Key="StatusTextBrush"/>
    </Window.Resources>

    <Window.TaskbarItemInfo>
        <TaskbarItemInfo/>
    </Window.TaskbarItemInfo>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>     <!-- Menu -->
            <RowDefinition Height="*"/>        <!-- Chat -->
            <RowDefinition Height="Auto"/>     <!-- Message queue -->
            <RowDefinition Height="Auto"/>     <!-- Attachments -->
            <RowDefinition Height="Auto"/>     <!-- CTA hint -->
            <RowDefinition Height="Auto"/>     <!-- Input -->
            <RowDefinition Height="Auto"/>     <!-- Changed files -->
            <RowDefinition Height="Auto"/>     <!-- Status bar -->
        </Grid.RowDefinitions>

        <!-- Menu bar with gradient border -->
        <StackPanel Grid.Row="0">
            <Menu Background="{StaticResource SurfaceBrush}">
                <MenuItem Header="_Chats"
                          ToolTip="Chat management: start new conversations, switch projects, browse history">
                    <MenuItem Header="New _Chat" Command="{Binding NewSessionCommand}"
                              InputGestureText="Ctrl+N"
                              ToolTip="Start a fresh conversation in the current project."/>
                    <MenuItem Header="Switch _Project" x:Name="SwitchProjectMenu"
                              Click="MenuItem_SwitchProject_Click"
                              ToolTip="Choose a different project folder and start a new chat."/>
                    <MenuItem Header="Chat _History..." Click="MenuItem_ChatHistory_Click"
                              ToolTip="Browse and reopen previous conversations."/>
                    <Separator/>
                    <MenuItem Header="E_xit" Click="MenuItem_Exit_Click"
                              ToolTip="Close the application. Window position and size are saved automatically."/>
                </MenuItem>
                <MenuItem Header="S_cripts" x:Name="ScriptsMenu" Visibility="Collapsed"/>
                <MenuItem Header="My _Tasks" x:Name="TasksMenu"
                          ToolTip="Shell commands: run predefined terminal commands in your project folder.&#x0a;Output appears in a separate window. Customize via tasks.json.&#x0a;Example: 'Git Status' runs 'git status' and displays the result."/>
                <MenuItem Header="_Help"
                          ToolTip="Updates and application information">
                    <MenuItem Header="Check for _Updates..." Command="{Binding CheckForUpdatesCommand}"
                              ToolTip="Check if a newer version is available on the update server.&#x0a;If found, download and install with one click. Also checks automatically every 4 hours."/>
                    <MenuItem Header="_Settings..." Click="MenuItem_Settings_Click"
                              ToolTip="Application settings: update channel, preferences."/>
                    <Separator/>
                    <MenuItem Header="_About" Click="MenuItem_About_Click"
                              ToolTip="Application version, build date, and support contacts."/>
                </MenuItem>
            </Menu>
            <!-- Gradient accent stripe (green → orange → yellow) -->
            <Border Height="2">
                <Border.Background>
                    <LinearGradientBrush StartPoint="0,0" EndPoint="1,0">
                        <GradientStop Color="#4CAF50" Offset="0"/>
                        <GradientStop Color="#FFAB1A" Offset="0.6"/>
                        <GradientStop Color="#F9A825" Offset="1"/>
                    </LinearGradientBrush>
                </Border.Background>
            </Border>
        </StackPanel>

        <!-- Chat area -->
        <ScrollViewer Grid.Row="1" x:Name="ChatScrollViewer"
                      VerticalScrollBarVisibility="Auto"
                      Padding="12">
            <ItemsControl ItemsSource="{Binding Messages}" x:Name="MessagesControl">
                <ItemsControl.ItemTemplate>
                    <DataTemplate DataType="{x:Type vm:MessageViewModel}">
                        <StackPanel>
                            <!-- THINKING block — separate prominent rectangle -->
                            <Border Margin="4,4,4,4"
                                    Padding="16,12"
                                    CornerRadius="8"
                                    MinWidth="250"
                                    HorizontalAlignment="Left"
                                    Background="{StaticResource ThinkingBubbleBrush}"
                                    BorderBrush="{StaticResource PrimaryBrush}"
                                    BorderThickness="1"
                                    Visibility="{Binding IsThinking, Converter={StaticResource BoolToVis}}">
                                <Border.Triggers>
                                    <EventTrigger RoutedEvent="Loaded">
                                        <BeginStoryboard>
                                            <Storyboard RepeatBehavior="Forever">
                                                <DoubleAnimation Storyboard.TargetProperty="Opacity"
                                                                 From="1.0" To="0.6"
                                                                 Duration="0:0:0.8"
                                                                 AutoReverse="True"/>
                                            </Storyboard>
                                        </BeginStoryboard>
                                    </EventTrigger>
                                </Border.Triggers>
                                <StackPanel Orientation="Horizontal">
                                    <TextBlock Text="&#x25CF; " FontSize="18"
                                               Foreground="{StaticResource PrimaryBrush}"
                                               VerticalAlignment="Center"/>
                                    <TextBlock Text="Claude is thinking..."
                                               FontFamily="Nunito,Segoe UI,sans-serif"
                                               FontSize="15"
                                               FontWeight="SemiBold"
                                               Foreground="{StaticResource PrimaryBrush}"
                                               VerticalAlignment="Center"/>
                                </StackPanel>
                            </Border>

                            <!-- Main message bubble -->
                            <Border Margin="4,4,4,4"
                                    Padding="12,8"
                                    CornerRadius="8"
                                    Background="{Binding Role, Converter={StaticResource RoleToBubble}}"
                                    HorizontalAlignment="{Binding Role, Converter={StaticResource RoleToAlign}}"
                                    MaxWidth="{Binding Role, Converter={StaticResource RoleToMaxWidth}}"
                                    Visibility="{Binding IsThinking, Converter={StaticResource BoolToVis}, ConverterParameter=Invert}">
                                <StackPanel>
                                    <!-- Timestamp -->
                                    <TextBlock Text="{Binding Timestamp, StringFormat='HH:mm'}"
                                               FontSize="10"
                                               Foreground="{StaticResource TextSecondaryBrush}"
                                               Opacity="0.5"
                                               Margin="0,0,0,2"/>
                                    <!-- Bookmark indicator -->
                                    <TextBlock Text="&#x2605;" FontSize="14"
                                               Foreground="{StaticResource AccentBrush}"
                                               HorizontalAlignment="Right"
                                               Margin="0,-2,0,0"
                                               Visibility="{Binding IsBookmarked, Converter={StaticResource BoolToVis}}"
                                               ToolTip="Bookmarked"/>
                                    <!-- Main text (selectable) -->
                                    <TextBox Text="{Binding Text, Mode=OneWay}"
                                             IsReadOnly="True"
                                             TextWrapping="Wrap"
                                             FontFamily="Cascadia Code,Consolas,Courier New"
                                             FontSize="13.5"
                                             Background="Transparent"
                                             BorderThickness="0"
                                             Padding="0"
                                             Foreground="{StaticResource TextBrush}"
                                             SelectionBrush="{StaticResource SelectionBrush}"
                                             IsTabStop="False"
                                             Cursor="IBeam">
                                        <TextBox.ContextMenu>
                                            <ContextMenu>
                                                <MenuItem Header="Copy Selection" Command="ApplicationCommands.Copy"/>
                                                <MenuItem Header="Copy All" Click="CopyAllMessage_Click"
                                                          Tag="{Binding Text}"/>
                                                <Separator/>
                                                <MenuItem Header="Bookmark" Click="ToggleBookmark_Click"/>
                                            </ContextMenu>
                                        </TextBox.ContextMenu>
                                    </TextBox>

                                    <!-- Completion summary panel -->
                                    <Border Margin="0,8,0,0"
                                            CornerRadius="6"
                                            Background="{StaticResource SurfaceLightBrush}"
                                            BorderBrush="{StaticResource SuccessBrush}"
                                            BorderThickness="2,0,0,0"
                                            Padding="10,8"
                                            Visibility="{Binding HasCompletionSummary, Converter={StaticResource BoolToVis}}">
                                        <StackPanel>
                                            <StackPanel Orientation="Horizontal" Margin="0,0,0,4">
                                                <TextBlock Text="&#x2714;" FontSize="13"
                                                           Foreground="{StaticResource SuccessBrush}"
                                                           VerticalAlignment="Center"
                                                           Margin="0,0,6,0"/>
                                                <TextBlock Text="Summary"
                                                           FontSize="12"
                                                           FontWeight="SemiBold"
                                                           Foreground="{StaticResource SuccessBrush}"
                                                           VerticalAlignment="Center"/>
                                            </StackPanel>
                                            <TextBox Text="{Binding CompletionSummary, Mode=OneWay}"
                                                     IsReadOnly="True"
                                                     TextWrapping="Wrap"
                                                     FontFamily="Cascadia Code,Consolas,Courier New"
                                                     FontSize="13"
                                                     Background="Transparent"
                                                     BorderThickness="0"
                                                     Padding="0"
                                                     Foreground="{StaticResource TextBrush}"
                                                     SelectionBrush="{StaticResource SelectionBrush}"
                                                     IsTabStop="False"
                                                     Cursor="IBeam">
                                                <TextBox.ContextMenu>
                                                    <ContextMenu>
                                                        <MenuItem Header="Copy Selection" Command="ApplicationCommands.Copy"/>
                                                        <MenuItem Header="Copy Summary" Click="CopyAllMessage_Click"
                                                                  Tag="{Binding CompletionSummary}"/>
                                                    </ContextMenu>
                                                </TextBox.ContextMenu>
                                            </TextBox>
                                        </StackPanel>
                                    </Border>

                                    <!-- Attachments (screenshots, files sent with this message) -->
                                    <ItemsControl ItemsSource="{Binding Attachments}"
                                                  Visibility="{Binding HasAttachments, Converter={StaticResource BoolToVis}}"
                                                  Margin="0,6,0,0">
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate>
                                                <Border Background="{StaticResource SurfaceLightBrush}"
                                                        CornerRadius="4" Padding="6,4" Margin="0,0,0,3"
                                                        Cursor="Hand"
                                                        MouseLeftButtonUp="AttachmentPreview_Click">
                                                    <StackPanel>
                                                        <StackPanel Orientation="Horizontal">
                                                            <TextBlock Text="{Binding FileTypeIcon}" FontSize="12"
                                                                       Margin="0,0,4,0" VerticalAlignment="Center"/>
                                                            <TextBlock Text="{Binding FileName}" FontSize="11"
                                                                       Foreground="{StaticResource PrimaryBrush}"
                                                                       VerticalAlignment="Center"/>
                                                        </StackPanel>
                                                        <!-- Image thumbnail -->
                                                        <Image MaxHeight="200" MaxWidth="400"
                                                               Stretch="Uniform" StretchDirection="DownOnly"
                                                               Margin="0,4,0,0"
                                                               HorizontalAlignment="Left"
                                                               Tag="{Binding FilePath}"
                                                               Loaded="AttachmentImage_Loaded">
                                                            <Image.Style>
                                                                <Style TargetType="Image">
                                                                    <Setter Property="Visibility" Value="Collapsed"/>
                                                                </Style>
                                                            </Image.Style>
                                                        </Image>
                                                    </StackPanel>
                                                </Border>
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>

                                    <!-- Inline images (detected from file paths in text) -->
                                    <ItemsControl ItemsSource="{Binding InlineImages}"
                                                  Visibility="{Binding HasInlineImages, Converter={StaticResource BoolToVis}}"
                                                  Margin="0,6,0,0">
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate>
                                                <Border Background="{StaticResource SurfaceLightBrush}"
                                                        CornerRadius="4" Padding="6,4" Margin="0,0,0,3"
                                                        Cursor="Hand"
                                                        MouseLeftButtonUp="InlineImage_Click">
                                                    <Image MaxHeight="300" MaxWidth="500"
                                                           Stretch="Uniform" StretchDirection="DownOnly"
                                                           HorizontalAlignment="Left"
                                                           Tag="{Binding}"
                                                           Loaded="AttachmentImage_Loaded">
                                                        <Image.Style>
                                                            <Style TargetType="Image">
                                                                <Setter Property="Visibility" Value="Collapsed"/>
                                                            </Style>
                                                        </Image.Style>
                                                    </Image>
                                                </Border>
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>

                                    <!-- Tool uses — compact summary with expandable details -->
                                    <Border Background="{StaticResource ToolBubbleBrush}"
                                            CornerRadius="4" Padding="6,4" Margin="0,6,0,0"
                                            Visibility="{Binding HasToolUses, Converter={StaticResource BoolToVis}}">
                                        <Expander IsExpanded="True"
                                                  Foreground="{StaticResource TextSecondaryBrush}">
                                            <Expander.Header>
                                                <StackPanel Orientation="Horizontal">
                                                    <TextBlock Text="&#x25CF; " FontSize="10"
                                                               Foreground="{StaticResource PrimaryBrush}"
                                                               VerticalAlignment="Center"/>
                                                    <TextBlock Text="{Binding ToolActivitySummary}"
                                                               FontSize="12"
                                                               Foreground="{StaticResource PrimaryBrush}"
                                                               VerticalAlignment="Center"/>
                                                </StackPanel>
                                            </Expander.Header>
                                            <ItemsControl ItemsSource="{Binding ToolUses}" Margin="4,4,0,0">
                                                <ItemsControl.ItemTemplate>
                                                    <DataTemplate DataType="{x:Type vm:ToolUseViewModel}">
                                                        <Border Margin="0,1" Padding="4,2"
                                                                CornerRadius="3">
                                                            <StackPanel>
                                                                <StackPanel Orientation="Horizontal" Cursor="Hand">
                                                                    <TextBlock FontSize="9" Margin="0,0,5,0"
                                                                               Foreground="{StaticResource PrimaryBrush}"
                                                                               VerticalAlignment="Center">
                                                                        <TextBlock.Style>
                                                                            <Style TargetType="TextBlock">
                                                                                <Setter Property="Text" Value="&#x25B6;"/>
                                                                                <Style.Triggers>
                                                                                    <DataTrigger Binding="{Binding IsExpanded}" Value="True">
                                                                                        <Setter Property="Text" Value="&#x25BC;"/>
                                                                                    </DataTrigger>
                                                                                </Style.Triggers>
                                                                            </Style>
                                                                        </TextBlock.Style>
                                                                    </TextBlock>
                                                                    <TextBlock Text="{Binding ToolName}"
                                                                               FontWeight="SemiBold"
                                                                               Foreground="{StaticResource PrimaryBrush}"
                                                                               FontSize="11.5"/>
                                                                    <TextBlock Text=": " FontSize="11.5"
                                                                               Foreground="{StaticResource TextSecondaryBrush}"
                                                                               Visibility="{Binding Summary, Converter={StaticResource BoolToVis}}"/>
                                                                    <TextBlock Text="{Binding Summary}"
                                                                               FontSize="11.5"
                                                                               Foreground="{StaticResource TextSecondaryBrush}"
                                                                               TextTrimming="CharacterEllipsis"
                                                                               MaxWidth="500"/>
                                                                    <StackPanel.InputBindings>
                                                                        <MouseBinding Gesture="LeftClick"
                                                                                      Command="{Binding ToggleExpandedCommand}"/>
                                                                    </StackPanel.InputBindings>
                                                                </StackPanel>
                                                                <!-- Expanded: show edit diff if available -->
                                                                <ItemsControl ItemsSource="{Binding EditDiffLines}"
                                                                              Margin="16,3,0,2"
                                                                              Visibility="{Binding HasEditDiff, Converter={StaticResource BoolToVis}}">
                                                                    <ItemsControl.Style>
                                                                        <Style TargetType="ItemsControl">
                                                                            <Setter Property="Visibility" Value="Collapsed"/>
                                                                            <Style.Triggers>
                                                                                <MultiDataTrigger>
                                                                                    <MultiDataTrigger.Conditions>
                                                                                        <Condition Binding="{Binding HasEditDiff}" Value="True"/>
                                                                                        <Condition Binding="{Binding IsExpanded}" Value="True"/>
                                                                                    </MultiDataTrigger.Conditions>
                                                                                    <Setter Property="Visibility" Value="Visible"/>
                                                                                </MultiDataTrigger>
                                                                            </Style.Triggers>
                                                                        </Style>
                                                                    </ItemsControl.Style>
                                                                    <ItemsControl.ItemTemplate>
                                                                        <DataTemplate>
                                                                            <TextBlock Text="{Binding DisplayText}"
                                                                                       FontFamily="Cascadia Code,Consolas,Courier New"
                                                                                       FontSize="11"
                                                                                       Foreground="{Binding Type, Converter={StaticResource DiffLineBrush}}"
                                                                                       Padding="0,0.5"/>
                                                                        </DataTemplate>
                                                                    </ItemsControl.ItemTemplate>
                                                                </ItemsControl>
                                                                <!-- Expanded: show result preview (when no diff) -->
                                                                <TextBox Text="{Binding ResultPreview, Mode=OneWay}"
                                                                         IsReadOnly="True"
                                                                         TextWrapping="Wrap"
                                                                         FontFamily="Cascadia Code,Consolas,Courier New"
                                                                         FontSize="11"
                                                                         Background="Transparent"
                                                                         BorderThickness="0"
                                                                         Padding="0"
                                                                         Foreground="{StaticResource TextSecondaryBrush}"
                                                                         SelectionBrush="{StaticResource SelectionBrush}"
                                                                         IsTabStop="False"
                                                                         MaxHeight="200"
                                                                         VerticalScrollBarVisibility="Auto"
                                                                         Margin="16,3,0,2">
                                                                    <TextBox.Style>
                                                                        <Style TargetType="TextBox">
                                                                            <Setter Property="Visibility" Value="Collapsed"/>
                                                                            <Style.Triggers>
                                                                                <MultiDataTrigger>
                                                                                    <MultiDataTrigger.Conditions>
                                                                                        <Condition Binding="{Binding IsExpanded}" Value="True"/>
                                                                                        <Condition Binding="{Binding HasEditDiff}" Value="False"/>
                                                                                    </MultiDataTrigger.Conditions>
                                                                                    <Setter Property="Visibility" Value="Visible"/>
                                                                                </MultiDataTrigger>
                                                                            </Style.Triggers>
                                                                        </Style>
                                                                    </TextBox.Style>
                                                                </TextBox>
                                                            </StackPanel>
                                                        </Border>
                                                    </DataTemplate>
                                                </ItemsControl.ItemTemplate>
                                            </ItemsControl>
                                        </Expander>
                                    </Border>

                                    <!-- Task/console output — collapsed by default -->
                                    <Border Background="{StaticResource ToolBubbleBrush}"
                                            CornerRadius="4" Padding="6,4" Margin="0,6,0,0"
                                            Visibility="{Binding HasTaskOutput, Converter={StaticResource BoolToVis}}">
                                        <Expander IsExpanded="False"
                                                  Foreground="{StaticResource TextSecondaryBrush}">
                                            <Expander.Header>
                                                <StackPanel Orientation="Horizontal">
                                                    <TextBlock Text="&#x25B6; " FontSize="10"
                                                               Foreground="{StaticResource PrimaryBrush}"
                                                               VerticalAlignment="Center"/>
                                                    <TextBlock Text="Console output"
                                                               FontSize="12"
                                                               Foreground="{StaticResource PrimaryBrush}"
                                                               VerticalAlignment="Center"/>
                                                </StackPanel>
                                            </Expander.Header>
                                            <TextBox Text="{Binding TaskOutputText, Mode=OneWay}"
                                                     IsReadOnly="True"
                                                     TextWrapping="Wrap"
                                                     FontFamily="Cascadia Code,Consolas,Courier New"
                                                     FontSize="11"
                                                     Background="Transparent"
                                                     BorderThickness="0"
                                                     Padding="4"
                                                     Foreground="{StaticResource TextSecondaryBrush}"
                                                     SelectionBrush="{StaticResource SelectionBrush}"
                                                     IsTabStop="False"
                                                     MaxHeight="400"
                                                     VerticalScrollBarVisibility="Auto"
                                                     Margin="4,3,0,2"/>
                                        </Expander>
                                    </Border>

                                    <!-- AskUserQuestion buttons -->
                                    <ItemsControl ItemsSource="{Binding QuestionDisplay.Options}"
                                                  Visibility="{Binding HasQuestion, Converter={StaticResource BoolToVis}}"
                                                  Margin="0,8,0,0">
                                        <ItemsControl.ItemsPanel>
                                            <ItemsPanelTemplate>
                                                <WrapPanel Orientation="Horizontal"/>
                                            </ItemsPanelTemplate>
                                        </ItemsControl.ItemsPanel>
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate>
                                                <Button Margin="0,0,6,4"
                                                        Padding="12,6"
                                                        Cursor="Hand"
                                                        IsEnabled="{Binding DataContext.QuestionDisplay.IsAnswered,
                                                            RelativeSource={RelativeSource AncestorType=ItemsControl},
                                                            Converter={StaticResource InverseBool}}"
                                                        Command="{Binding DataContext.AnswerQuestionCommand,
                                                            RelativeSource={RelativeSource AncestorType=Window}}"
                                                        CommandParameter="{Binding Label}"
                                                        ToolTip="{Binding Description}">
                                                    <Button.Style>
                                                        <Style TargetType="Button">
                                                            <Setter Property="Background" Value="{StaticResource SurfaceLightBrush}"/>
                                                            <Setter Property="Foreground" Value="{StaticResource PrimaryBrush}"/>
                                                            <Setter Property="BorderBrush" Value="{StaticResource PrimaryBrush}"/>
                                                            <Setter Property="BorderThickness" Value="1"/>
                                                            <Setter Property="FontSize" Value="12"/>
                                                            <Setter Property="FontWeight" Value="SemiBold"/>
                                                            <Setter Property="Template">
                                                                <Setter.Value>
                                                                    <ControlTemplate TargetType="Button">
                                                                        <Border Background="{TemplateBinding Background}"
                                                                                BorderBrush="{TemplateBinding BorderBrush}"
                                                                                BorderThickness="{TemplateBinding BorderThickness}"
                                                                                CornerRadius="6"
                                                                                Padding="{TemplateBinding Padding}"
                                                                                Opacity="{TemplateBinding Opacity}">
                                                                            <ContentPresenter HorizontalAlignment="Center"
                                                                                              VerticalAlignment="Center"/>
                                                                        </Border>
                                                                        <ControlTemplate.Triggers>
                                                                            <Trigger Property="IsMouseOver" Value="True">
                                                                                <Setter Property="Background"
                                                                                        Value="{StaticResource PrimaryBrush}"/>
                                                                                <Setter Property="Foreground"
                                                                                        Value="{StaticResource BackgroundBrush}"/>
                                                                            </Trigger>
                                                                            <Trigger Property="IsEnabled" Value="False">
                                                                                <Setter Property="Opacity" Value="0.4"/>
                                                                                <Setter Property="Cursor" Value="Arrow"/>
                                                                            </Trigger>
                                                                        </ControlTemplate.Triggers>
                                                                    </ControlTemplate>
                                                                </Setter.Value>
                                                            </Setter>
                                                        </Style>
                                                    </Button.Style>
                                                    <TextBlock Text="{Binding Label}"/>
                                                </Button>
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>

                                    <!-- Streaming indicator -->
                                    <TextBlock Text="&#x25CF;" FontSize="16"
                                               Foreground="{StaticResource PrimaryBrush}"
                                               Visibility="{Binding IsStreaming, Converter={StaticResource BoolToVis}}"
                                               Margin="0,4,0,0">
                                        <TextBlock.Triggers>
                                            <EventTrigger RoutedEvent="Loaded">
                                                <BeginStoryboard>
                                                    <Storyboard RepeatBehavior="Forever">
                                                        <DoubleAnimation Storyboard.TargetProperty="Opacity"
                                                                         From="1" To="0.2"
                                                                         Duration="0:0:0.6"
                                                                         AutoReverse="True"/>
                                                    </Storyboard>
                                                </BeginStoryboard>
                                            </EventTrigger>
                                        </TextBlock.Triggers>
                                    </TextBlock>
                                </StackPanel>
                            </Border>
                        </StackPanel>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
        </ScrollViewer>

        <!-- Rate limit banner -->
        <Border Grid.Row="1"
                VerticalAlignment="Top"
                HorizontalAlignment="Stretch"
                Panel.ZIndex="15"
                Visibility="{Binding ShowRateLimitBanner, Converter={StaticResource BoolToVis}}">
            <Border Background="#CC45475a"
                    BorderBrush="{StaticResource WarningBrush}"
                    BorderThickness="0,0,0,2"
                    Padding="16,10">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    <TextBlock Grid.Column="0" Text="&#x23F3; " FontSize="16"
                               Foreground="{StaticResource WarningBrush}"
                               VerticalAlignment="Center" Margin="0,0,8,0"/>
                    <StackPanel Grid.Column="1" VerticalAlignment="Center">
                        <TextBlock FontSize="13" FontWeight="SemiBold"
                                   Foreground="{StaticResource TextBrush}">
                            <Run Text="Rate limit reached. Resets in "/>
                            <Run Text="{Binding RateLimitCountdown, Mode=OneWay}"
                                 Foreground="{StaticResource WarningBrush}"/>
                        </TextBlock>
                        <TextBlock Text="Your session will auto-resume when ready."
                                   FontSize="11" Foreground="{StaticResource TextSecondaryBrush}"
                                   Margin="0,2,0,0"/>
                    </StackPanel>
                    <Button Grid.Column="2" Content="Upgrade Account"
                            Margin="12,0,0,0" Padding="12,4"
                            Cursor="Hand"
                            Command="{Binding UpgradeAccountCommand}"
                            ToolTip="Open Anthropic billing page in browser">
                        <Button.Style>
                            <Style TargetType="Button">
                                <Setter Property="Background" Value="Transparent"/>
                                <Setter Property="Foreground" Value="{StaticResource PrimaryBrush}"/>
                                <Setter Property="BorderBrush" Value="{StaticResource PrimaryBrush}"/>
                                <Setter Property="BorderThickness" Value="1"/>
                                <Setter Property="FontSize" Value="11"/>
                                <Setter Property="Template">
                                    <Setter.Value>
                                        <ControlTemplate TargetType="Button">
                                            <Border Background="{TemplateBinding Background}"
                                                    BorderBrush="{TemplateBinding BorderBrush}"
                                                    BorderThickness="{TemplateBinding BorderThickness}"
                                                    CornerRadius="4"
                                                    Padding="{TemplateBinding Padding}">
                                                <ContentPresenter HorizontalAlignment="Center"
                                                                  VerticalAlignment="Center"/>
                                            </Border>
                                            <ControlTemplate.Triggers>
                                                <Trigger Property="IsMouseOver" Value="True">
                                                    <Setter Property="Background"
                                                            Value="{StaticResource PrimaryBrush}"/>
                                                    <Setter Property="Foreground"
                                                            Value="{StaticResource BackgroundBrush}"/>
                                                </Trigger>
                                            </ControlTemplate.Triggers>
                                        </ControlTemplate>
                                    </Setter.Value>
                                </Setter>
                            </Style>
                        </Button.Style>
                    </Button>
                    <Button Grid.Column="3" Content="&#x2715;"
                            Margin="8,0,0,0" Padding="6,2"
                            Cursor="Hand"
                            Command="{Binding DismissRateLimitCommand}"
                            ToolTip="Dismiss">
                        <Button.Style>
                            <Style TargetType="Button">
                                <Setter Property="Background" Value="Transparent"/>
                                <Setter Property="Foreground" Value="{StaticResource TextSecondaryBrush}"/>
                                <Setter Property="BorderThickness" Value="0"/>
                                <Setter Property="FontSize" Value="14"/>
                                <Setter Property="Template">
                                    <Setter.Value>
                                        <ControlTemplate TargetType="Button">
                                            <Border Background="Transparent" Padding="{TemplateBinding Padding}">
                                                <ContentPresenter HorizontalAlignment="Center"
                                                                  VerticalAlignment="Center"/>
                                            </Border>
                                        </ControlTemplate>
                                    </Setter.Value>
                                </Setter>
                            </Style>
                        </Button.Style>
                    </Button>
                </Grid>
            </Border>
        </Border>

        <!-- Bookmarks button -->
        <Border x:Name="BookmarksButton"
                Grid.Row="1"
                HorizontalAlignment="Right"
                VerticalAlignment="Bottom"
                Margin="0,0,24,48"
                Panel.ZIndex="5"
                Visibility="Collapsed"
                Cursor="Hand"
                MouseLeftButtonUp="BookmarksButton_Click"
                ToolTip="Jump to bookmarked messages">
            <Border Background="{StaticResource SurfaceLightBrush}"
                    BorderBrush="{StaticResource BorderBrush}"
                    BorderThickness="1"
                    CornerRadius="16"
                    Padding="10,6">
                <TextBlock Text="&#x2605; Bookmarks" FontSize="12" FontWeight="SemiBold"
                           Foreground="{StaticResource AccentBrush}"/>
            </Border>
            <Border.ContextMenu>
                <ContextMenu x:Name="BookmarksContextMenu"
                             Background="{StaticResource SurfaceBrush}"
                             BorderBrush="{StaticResource BorderBrush}"
                             Foreground="{StaticResource TextBrush}"/>
            </Border.ContextMenu>
        </Border>

        <!-- Scroll to bottom button -->
        <Button x:Name="ScrollToBottomButton"
                Grid.Row="1"
                HorizontalAlignment="Right"
                VerticalAlignment="Bottom"
                Margin="0,0,24,12"
                Panel.ZIndex="5"
                Visibility="Collapsed"
                Click="ScrollToBottomButton_Click"
                Cursor="Hand"
                ToolTip="Scroll to bottom">
            <Button.Style>
                <Style TargetType="Button">
                    <Setter Property="Background" Value="{StaticResource SurfaceLightBrush}"/>
                    <Setter Property="Foreground" Value="{StaticResource TextBrush}"/>
                    <Setter Property="BorderThickness" Value="1"/>
                    <Setter Property="BorderBrush" Value="{StaticResource BorderBrush}"/>
                    <Setter Property="Template">
                        <Setter.Value>
                            <ControlTemplate TargetType="Button">
                                <Border Background="{TemplateBinding Background}"
                                        BorderBrush="{TemplateBinding BorderBrush}"
                                        BorderThickness="{TemplateBinding BorderThickness}"
                                        CornerRadius="16"
                                        Padding="10,6">
                                    <TextBlock Text="&#x25BC; Down"
                                               FontSize="12"
                                               FontWeight="SemiBold"
                                               Foreground="{StaticResource PrimaryBrush}"/>
                                </Border>
                                <ControlTemplate.Triggers>
                                    <Trigger Property="IsMouseOver" Value="True">
                                        <Setter Property="Background" Value="{StaticResource MenuHighlightBrush}"/>
                                    </Trigger>
                                </ControlTemplate.Triggers>
                            </ControlTemplate>
                        </Setter.Value>
                    </Setter>
                </Style>
            </Button.Style>
        </Button>

        <!-- Finalize Actions popup -->
        <Border x:Name="FinalizePopupBorder"
                Grid.Row="1"
                HorizontalAlignment="Right"
                VerticalAlignment="Bottom"
                Margin="0,0,24,12"
                Panel.ZIndex="15"
                Visibility="{Binding ShowTaskSuggestion, Converter={StaticResource BoolToVis}}"
                MaxWidth="320"
                RenderTransformOrigin="1,1">
            <Border.RenderTransform>
                <ScaleTransform ScaleX="1" ScaleY="1"/>
            </Border.RenderTransform>
            <Border Background="{StaticResource SurfaceBrush}"
                    BorderBrush="{StaticResource BorderBrush}"
                    BorderThickness="1"
                    CornerRadius="8"
                    Padding="16,12">
                <Border.Effect>
                    <DropShadowEffect Color="Black" Opacity="0.4" BlurRadius="16" ShadowDepth="4"/>
                </Border.Effect>
                <StackPanel>
                    <!-- Header with timer and close button -->
                    <Grid Margin="0,0,0,10">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <TextBlock Grid.Column="0"
                                   Text="&#x26A1; Finalize Actions"
                                   FontSize="14" FontWeight="SemiBold"
                                   Foreground="{StaticResource WarningBrush}"
                                   VerticalAlignment="Center"/>
                        <TextBlock Grid.Column="1"
                                   Text="{Binding FinalizeCountdown, StringFormat={}{0}s}"
                                   FontSize="11"
                                   Foreground="{StaticResource TextSecondaryBrush}"
                                   VerticalAlignment="Center"
                                   Margin="8,0,4,0"/>
                        <Button Grid.Column="2"
                                Content="&#x2715;"
                                Command="{Binding CloseFinalizePopupCommand}"
                                Background="Transparent"
                                Foreground="{StaticResource TextSecondaryBrush}"
                                BorderThickness="0"
                                FontSize="14"
                                Cursor="Hand"
                                Padding="4,0"
                                ToolTip="Collapse"/>
                    </Grid>

                    <!-- Dynamic action buttons -->
                    <ItemsControl ItemsSource="{Binding SuggestedTasks}">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Button Command="{Binding DataContext.RunSuggestedTaskCommand,
                                            RelativeSource={RelativeSource AncestorType=Window}}"
                                        CommandParameter="{Binding}"
                                        HorizontalAlignment="Stretch"
                                        Margin="0,0,0,4"
                                        Padding="12,7"
                                        FontSize="12.5"
                                        IsEnabled="{Binding IsCompleted, Converter={StaticResource InverseBool}}">
                                    <Button.Style>
                                        <Style TargetType="Button" BasedOn="{StaticResource PrimaryButton}">
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding IsCompleted}" Value="True">
                                                    <Setter Property="Opacity" Value="0.5"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </Button.Style>
                                    <Button.Content>
                                        <TextBlock>
                                            <TextBlock.Style>
                                                <Style TargetType="TextBlock">
                                                    <Setter Property="Text" Value="{Binding Label}"/>
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding IsCompleted}" Value="True">
                                                            <Setter Property="Text" Value="{Binding CompletedStatusText}"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </TextBlock.Style>
                                        </TextBlock>
                                    </Button.Content>
                                </Button>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>

                    <!-- Small "Don't suggest" link -->
                    <Border Cursor="Hand" Background="Transparent"
                            HorizontalAlignment="Right" Margin="0,6,0,0">
                        <Border.InputBindings>
                            <MouseBinding MouseAction="LeftClick"
                                          Command="{Binding DontSuggestForProjectCommand}"/>
                        </Border.InputBindings>
                        <TextBlock Text="Don't suggest for this project"
                                   FontSize="10.5"
                                   Foreground="{StaticResource TextSecondaryBrush}"
                                   TextDecorations="Underline"
                                   ToolTip="Stop showing finalize actions for this project"/>
                    </Border>
                </StackPanel>
            </Border>
        </Border>

        <!-- Welcome overlay -->
        <Border Grid.Row="1"
                Background="{StaticResource BackgroundBrush}"
                Visibility="{Binding ShowWelcome, Converter={StaticResource BoolToVis}}"
                Panel.ZIndex="10">
            <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center"
                        MaxWidth="500" Margin="40">
                <TextBlock Text="Welcome to ClaudeCodeWin!"
                           FontSize="24" FontWeight="Bold"
                           Foreground="{StaticResource PrimaryBrush}"
                           HorizontalAlignment="Center"
                           Margin="0,0,0,12"/>
                <TextBlock Text="Select a project folder to get started."
                           FontSize="14"
                           Foreground="{StaticResource TextSecondaryBrush}"
                           HorizontalAlignment="Center"
                           Margin="0,0,0,24"/>

                <Button Content="Browse..."
                        Style="{StaticResource PrimaryButton}"
                        Command="{Binding SelectFolderCommand}"
                        HorizontalAlignment="Center"
                        Margin="0,0,0,24"
                        Padding="32,10"/>

                <!-- Recent folders -->
                <TextBlock Text="Recent Projects"
                           FontSize="14" FontWeight="SemiBold"
                           Foreground="{StaticResource TextBrush}"
                           Margin="0,0,0,8"
                           Visibility="{Binding RecentFolders.Count, Converter={StaticResource BoolToVis}}"/>

                <ItemsControl ItemsSource="{Binding RecentFolders}"
                              Visibility="{Binding RecentFolders.Count, Converter={StaticResource BoolToVis}}">
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <Border Background="{StaticResource SurfaceBrush}"
                                    CornerRadius="6" Padding="12,8" Margin="0,0,0,4"
                                    Cursor="Hand">
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>

                                    <TextBlock Grid.Column="0" Text="{Binding}"
                                               FontSize="13"
                                               Foreground="{StaticResource TextBrush}"
                                               VerticalAlignment="Center"
                                               TextTrimming="CharacterEllipsis"/>

                                    <Button Grid.Column="1"
                                            Style="{StaticResource ChipCloseButton}"
                                            Command="{Binding DataContext.RemoveRecentFolderCommand,
                                                RelativeSource={RelativeSource AncestorType=Window}}"
                                            CommandParameter="{Binding}"
                                            Margin="8,0,0,0"/>
                                </Grid>

                                <Border.InputBindings>
                                    <MouseBinding Gesture="LeftClick"
                                                  Command="{Binding DataContext.OpenRecentFolderCommand,
                                                      RelativeSource={RelativeSource AncestorType=Window}}"
                                                  CommandParameter="{Binding}"/>
                                </Border.InputBindings>

                                <Border.Style>
                                    <Style TargetType="Border">
                                        <Style.Triggers>
                                            <Trigger Property="IsMouseOver" Value="True">
                                                <Setter Property="Background" Value="{StaticResource SurfaceLightBrush}"/>
                                            </Trigger>
                                        </Style.Triggers>
                                    </Style>
                                </Border.Style>
                            </Border>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </StackPanel>
        </Border>


        <!-- Message queue -->
        <Border Grid.Row="2"
                Background="{StaticResource SurfaceBrush}"
                Padding="8,4"
                Visibility="{Binding HasQueuedMessages, Converter={StaticResource BoolToVis}}"
                BorderBrush="{StaticResource BorderBrush}"
                BorderThickness="0,1,0,0">
            <StackPanel>
                <TextBlock Text="Queued messages:" FontSize="11" FontWeight="SemiBold"
                           Foreground="{StaticResource TextSecondaryBrush}" Margin="4,0,0,4"/>
                <ItemsControl ItemsSource="{Binding MessageQueue}">
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <Border Background="{StaticResource SurfaceLightBrush}"
                                    CornerRadius="4" Padding="8,4" Margin="0,0,0,3">
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Grid.Column="0" Text="&#x23F3;" FontSize="11"
                                               Foreground="{StaticResource TextSecondaryBrush}"
                                               VerticalAlignment="Center" Margin="0,0,6,0"/>
                                    <TextBlock Grid.Column="1" Text="{Binding Text}"
                                               FontSize="12" TextTrimming="CharacterEllipsis"
                                               Foreground="{StaticResource TextBrush}"
                                               VerticalAlignment="Center"/>
                                    <!-- Send now: cancel current + send this -->
                                    <Border Grid.Column="2" Cursor="Hand" Background="Transparent"
                                            Margin="4,0,0,0" ToolTip="Send now (cancel current task)">
                                        <Border.InputBindings>
                                            <MouseBinding Gesture="LeftClick"
                                                          Command="{Binding DataContext.SendQueuedNowCommand,
                                                              RelativeSource={RelativeSource AncestorType=Window}}"
                                                          CommandParameter="{Binding}"/>
                                        </Border.InputBindings>
                                        <TextBlock Text="&#x25B6;" FontSize="10"
                                                   Foreground="{StaticResource SuccessBrush}"
                                                   VerticalAlignment="Center" Padding="2,0"/>
                                    </Border>
                                    <!-- Return to input textbox -->
                                    <Border Grid.Column="3" Cursor="Hand" Background="Transparent"
                                            Margin="4,0,0,0" ToolTip="Return to input (edit message)">
                                        <Border.InputBindings>
                                            <MouseBinding Gesture="LeftClick"
                                                          Command="{Binding DataContext.ReturnQueuedToInputCommand,
                                                              RelativeSource={RelativeSource AncestorType=Window}}"
                                                          CommandParameter="{Binding}"/>
                                        </Border.InputBindings>
                                        <TextBlock Text="&#x21A9;" FontSize="12"
                                                   Foreground="{StaticResource PrimaryBrush}"
                                                   VerticalAlignment="Center" Padding="2,0"/>
                                    </Border>
                                    <!-- Delete from queue -->
                                    <Button Grid.Column="4" Style="{StaticResource ChipCloseButton}"
                                            Command="{Binding DataContext.RemoveQueuedMessageCommand,
                                                RelativeSource={RelativeSource AncestorType=Window}}"
                                            CommandParameter="{Binding}"
                                            ToolTip="Remove from queue"/>
                                </Grid>
                            </Border>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </StackPanel>
        </Border>

        <!-- Attachments bar -->
        <Border Grid.Row="3"
                Background="{StaticResource SurfaceBrush}"
                Padding="8,4"
                Visibility="{Binding HasAttachments, Converter={StaticResource BoolToVis}}"
                x:Name="AttachmentBar">
            <ItemsControl ItemsSource="{Binding Attachments}">
                <ItemsControl.ItemsPanel>
                    <ItemsPanelTemplate>
                        <WrapPanel Orientation="Horizontal"/>
                    </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>
                <ItemsControl.ItemTemplate>
                    <DataTemplate>
                        <Border Style="{StaticResource ChipBorder}">
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="{Binding FileTypeIcon}" FontSize="12" Margin="0,0,4,0"
                                           VerticalAlignment="Center"/>
                                <TextBlock Text="{Binding FileName}"
                                           FontSize="12"
                                           Foreground="{StaticResource TextBrush}"
                                           VerticalAlignment="Center"/>
                                <!-- Preview button for images -->
                                <Button Content="&#x1F441;" FontSize="11" Padding="4,0"
                                        Margin="4,0,0,0" Cursor="Hand"
                                        VerticalAlignment="Center"
                                        Visibility="{Binding IsImage, Converter={StaticResource BoolToVis}}"
                                        Command="{Binding DataContext.PreviewAttachmentCommand,
                                            RelativeSource={RelativeSource AncestorType=Window}}"
                                        CommandParameter="{Binding}"
                                        ToolTip="Preview image">
                                    <Button.Style>
                                        <Style TargetType="Button">
                                            <Setter Property="Background" Value="Transparent"/>
                                            <Setter Property="BorderThickness" Value="0"/>
                                            <Setter Property="Template">
                                                <Setter.Value>
                                                    <ControlTemplate TargetType="Button">
                                                        <Border Background="Transparent" Padding="{TemplateBinding Padding}">
                                                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                                        </Border>
                                                    </ControlTemplate>
                                                </Setter.Value>
                                            </Setter>
                                        </Style>
                                    </Button.Style>
                                </Button>
                                <Button Style="{StaticResource ChipCloseButton}"
                                        Command="{Binding DataContext.RemoveAttachmentCommand,
                                            RelativeSource={RelativeSource AncestorType=Window}}"
                                        CommandParameter="{Binding}"/>
                            </StackPanel>
                        </Border>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
        </Border>

        <!-- CTA hint -->
        <Border Grid.Row="4"
                Padding="12,6"
                Visibility="{Binding HasCta, Converter={StaticResource BoolToVis}}">
            <TextBlock Text="{Binding CtaText}"
                       FontSize="12"
                       FontWeight="SemiBold"
                       Foreground="{StaticResource PrimaryBrush}"
                       HorizontalAlignment="Center"
                       Opacity="0.85"/>
        </Border>

        <!-- Input area -->
        <Grid Grid.Row="5" Margin="8">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>

            <Grid Grid.Column="0">
                <TextBox x:Name="InputTextBox"
                         Style="{StaticResource InputTextBox}"
                         Text="{Binding InputText, UpdateSourceTrigger=PropertyChanged}"
                         IsEnabled="{Binding IsUpdating, Converter={StaticResource InverseBool}}"
                         MaxHeight="200"
                         MinHeight="40"
                         VerticalAlignment="Stretch"/>
                <!-- Placeholder text -->
                <TextBlock Text="Type your message here... (Enter to send, Shift+Enter for newline)"
                           IsHitTestVisible="False"
                           Foreground="{StaticResource TextSecondaryBrush}"
                           FontFamily="Cascadia Code,Consolas,Courier New"
                           FontSize="13"
                           FontStyle="Italic"
                           Margin="12,10,0,0"
                           VerticalAlignment="Top">
                    <TextBlock.Style>
                        <Style TargetType="TextBlock" BasedOn="{StaticResource {x:Type TextBlock}}">
                            <Setter Property="Visibility" Value="Collapsed"/>
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding InputText}" Value="">
                                    <Setter Property="Visibility" Value="Visible"/>
                                </DataTrigger>
                                <DataTrigger Binding="{Binding InputText}" Value="{x:Null}">
                                    <Setter Property="Visibility" Value="Visible"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </TextBlock.Style>
                </TextBlock>
                <!-- Update in progress overlay -->
                <TextBlock Text="Please wait for the update to complete"
                           IsHitTestVisible="False"
                           Foreground="{StaticResource WarningBrush}"
                           FontFamily="Nunito,Segoe UI,sans-serif"
                           FontSize="13"
                           FontWeight="SemiBold"
                           Margin="12,10,0,0"
                           VerticalAlignment="Top"
                           Visibility="{Binding IsUpdating, Converter={StaticResource BoolToVis}}"/>

                <!-- Autocomplete popup -->
                <Popup x:Name="AutocompletePopup"
                       PlacementTarget="{Binding ElementName=InputTextBox}"
                       Placement="Relative"
                       StaysOpen="False"
                       AllowsTransparency="True"
                       PopupAnimation="Fade"
                       MaxHeight="280">
                    <Border Background="{StaticResource SurfaceBrush}"
                            BorderBrush="{StaticResource BorderBrush}"
                            BorderThickness="1"
                            CornerRadius="4"
                            Padding="0,4">
                        <ListBox x:Name="AutocompleteList"
                                 Background="Transparent"
                                 BorderThickness="0"
                                 Foreground="{StaticResource TextBrush}"
                                 FontFamily="Cascadia Code,Consolas,Courier New"
                                 FontSize="13"
                                 MaxHeight="260"
                                 ScrollViewer.HorizontalScrollBarVisibility="Disabled">
                            <ListBox.ItemContainerStyle>
                                <Style TargetType="ListBoxItem">
                                    <Setter Property="Foreground" Value="{StaticResource TextBrush}"/>
                                    <Setter Property="Padding" Value="8,4"/>
                                    <Setter Property="Cursor" Value="Hand"/>
                                    <Setter Property="Template">
                                        <Setter.Value>
                                            <ControlTemplate TargetType="ListBoxItem">
                                                <Border x:Name="Bd" Background="Transparent" Padding="8,4">
                                                    <ContentPresenter/>
                                                </Border>
                                                <ControlTemplate.Triggers>
                                                    <Trigger Property="IsSelected" Value="True">
                                                        <Setter TargetName="Bd" Property="Background"
                                                                Value="{StaticResource MenuHighlightBrush}"/>
                                                    </Trigger>
                                                    <Trigger Property="IsMouseOver" Value="True">
                                                        <Setter TargetName="Bd" Property="Background"
                                                                Value="{StaticResource SurfaceLightBrush}"/>
                                                    </Trigger>
                                                </ControlTemplate.Triggers>
                                            </ControlTemplate>
                                        </Setter.Value>
                                    </Setter>
                                </Style>
                            </ListBox.ItemContainerStyle>
                        </ListBox>
                    </Border>
                </Popup>
            </Grid>

            <StackPanel Grid.Column="1" Margin="8,0,0,0" VerticalAlignment="Bottom">
                <!-- Finalize Actions collapsed label (above Send) -->
                <Border Cursor="Hand" Background="Transparent"
                        Margin="0,0,0,4"
                        Visibility="{Binding ShowFinalizeActionsLabel, Converter={StaticResource BoolToVis}}"
                        MouseLeftButtonUp="FinalizeActions_Click">
                    <TextBlock x:Name="FinalizeLabelText"
                               Text="&#x26A1; Finalize Actions &#x25B2;" FontSize="11"
                               Foreground="{StaticResource WarningBrush}"
                               HorizontalAlignment="Center"
                               Padding="4,2"
                               ToolTip="Open finalize actions panel">
                        <TextBlock.Resources>
                            <Storyboard x:Key="BlinkStoryboard" RepeatBehavior="10x">
                                <DoubleAnimation Storyboard.TargetProperty="Opacity"
                                                 From="1" To="0.2" Duration="0:0:0.25"
                                                 AutoReverse="True"/>
                            </Storyboard>
                        </TextBlock.Resources>
                    </TextBlock>
                </Border>
                <Button Content="Send"
                        Style="{StaticResource PrimaryButton}"
                        Command="{Binding SendCommand}"
                        IsEnabled="{Binding IsUpdating, Converter={StaticResource InverseBool}}"
                        Margin="0,0,0,4"/>
            </StackPanel>
        </Grid>

        <!-- Changed files indicator -->
        <Border Grid.Row="6"
                Background="{StaticResource SurfaceBrush}"
                Padding="8,3"
                Visibility="{Binding HasChangedFiles, Converter={StaticResource BoolToVis}}"
                BorderBrush="{StaticResource BorderBrush}"
                BorderThickness="0,1,0,0">
            <Expander IsExpanded="False" Foreground="{StaticResource TextSecondaryBrush}">
                <Expander.Header>
                    <TextBlock Text="{Binding ChangedFilesText}" FontSize="11"
                               Foreground="{StaticResource AccentBrush}"/>
                </Expander.Header>
                <ItemsControl ItemsSource="{Binding ChangedFiles}" Margin="16,2,0,2">
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <Border Cursor="Hand" Background="Transparent"
                                    Margin="0,1" Padding="2,1"
                                    ToolTip="Click to view changes">
                                <Border.InputBindings>
                                    <MouseBinding Gesture="LeftClick"
                                                  Command="{Binding DataContext.ViewChangedFileCommand,
                                                      RelativeSource={RelativeSource AncestorType=Window}}"
                                                  CommandParameter="{Binding}"/>
                                </Border.InputBindings>
                                <TextBlock Text="{Binding}" FontSize="11"
                                           FontFamily="Cascadia Code,Consolas,Courier New"
                                           Foreground="{StaticResource PrimaryBrush}"
                                           TextDecorations="Underline"/>
                                <Border.Style>
                                    <Style TargetType="Border">
                                        <Style.Triggers>
                                            <Trigger Property="IsMouseOver" Value="True">
                                                <Setter Property="Background"
                                                        Value="{StaticResource SurfaceLightBrush}"/>
                                            </Trigger>
                                        </Style.Triggers>
                                    </Style>
                                </Border.Style>
                            </Border>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </Expander>
        </Border>

        <!-- Status bar -->
        <Border Grid.Row="7" Style="{StaticResource StatusBarStyle}">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="8"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <TextBlock Grid.Column="0" Text="{Binding StatusText}"
                           FontSize="12"
                           Foreground="{Binding StatusText, Converter={StaticResource StatusTextBrush}}"
                           VerticalAlignment="Center"/>
                <StackPanel Grid.Column="2" Orientation="Horizontal"
                            VerticalAlignment="Center" Margin="0,0,16,0">
                    <TextBlock Text="{Binding ProjectParentPath}"
                               FontSize="11" Foreground="{StaticResource TextSecondaryBrush}"
                               Opacity="0.7"
                               TextTrimming="CharacterEllipsis"/>
                    <TextBlock Text="{Binding ProjectFolderName}"
                               FontSize="11" FontWeight="SemiBold"
                               Foreground="{StaticResource AccentBrush}"/>
                </StackPanel>
                <TextBlock Grid.Column="3" Text="{Binding GitStatusText}"
                           FontSize="12"
                           Foreground="{Binding GitStatusText, Converter={StaticResource GitStatusBrush}}"
                           VerticalAlignment="Center" Margin="0,0,16,0"
                           ToolTip="Git repository status. Commit your changes regularly for safe rollback."/>
                <TextBlock Grid.Column="4" Text="{Binding ContextUsageText}"
                           FontSize="11"
                           Foreground="{StaticResource AccentBrush}"
                           VerticalAlignment="Center" Margin="0,0,16,0"
                           ToolTip="Context window usage. Shows what percentage of Claude's memory is used.&#x0a;At 80%+ consider starting a new session or expanding to 1M tokens."/>
                <Border Grid.Column="5" VerticalAlignment="Center" Margin="0,0,16,0"
                        Cursor="Hand" Background="Transparent"
                        MouseLeftButtonUp="MemoryIndicator_Click"
                        ToolTip="Usage limits from your Anthropic subscription.&#x0a;Session resets every 5 hours, weekly every 7 days.&#x0a;Click for session menu.">
                    <StackPanel Orientation="Horizontal">
                        <TextBlock Text="{Binding UsageText}"
                                   FontSize="11" Foreground="{StaticResource TextSecondaryBrush}"
                                   VerticalAlignment="Center"/>
                        <TextBlock Text=" &#x25BC;" FontSize="7"
                                   Foreground="{StaticResource TextSecondaryBrush}"
                                   VerticalAlignment="Center" Margin="2,1,0,0"/>
                    </StackPanel>
                    <Border.ContextMenu>
                        <ContextMenu x:Name="MemoryContextMenu">
                            <MenuItem Header="New Session" Command="{Binding NewSessionCommand}"
                                      InputGestureText="Ctrl+N"
                                      ToolTip="Start a fresh conversation. Clears history and resets memory usage."/>
                            <MenuItem Header="Expand Context (1M tokens)"
                                      Command="{Binding ExpandContextCommand}"
                                      ToolTip="Toggle between standard and extended context window."/>
                        </ContextMenu>
                    </Border.ContextMenu>
                </Border>
                <Border Grid.Column="6" VerticalAlignment="Center"
                        Background="Transparent"
                        MouseLeftButtonUp="ModelIndicator_Click">
                    <TextBlock Text="{Binding ModelName}"
                               FontSize="12" Foreground="{StaticResource PrimaryBrush}"/>
                    <Border.ContextMenu>
                        <ContextMenu x:Name="ModelContextMenu">
                            <MenuItem Header="Switch to Opus (new session)"
                                      Command="{Binding SwitchToOpusCommand}"
                                      ToolTip="Start a new session with claude-opus model."/>
                        </ContextMenu>
                    </Border.ContextMenu>
                </Border>
            </Grid>
        </Border>
        <!-- Update overlay (covers entire window during update) -->
        <Border Grid.Row="0" Grid.RowSpan="8"
                Background="#DD1e1e2e"
                Panel.ZIndex="101"
                Visibility="{Binding ShowUpdateOverlay, Converter={StaticResource BoolToVis}}">
            <Border HorizontalAlignment="Center" VerticalAlignment="Center"
                    Background="{StaticResource SurfaceBrush}"
                    CornerRadius="12" Padding="32"
                    Width="480"
                    BorderBrush="{StaticResource BorderBrush}"
                    BorderThickness="1">
                <StackPanel>
                    <!-- Title -->
                    <TextBlock Text="Update Available"
                               FontSize="18" FontWeight="Bold"
                               Foreground="{StaticResource PrimaryBrush}"
                               Margin="0,0,0,6">
                        <TextBlock.Style>
                            <Style TargetType="TextBlock">
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding UpdateDownloading}" Value="True">
                                        <Setter Property="Text" Value="Updating..."/>
                                    </DataTrigger>
                                    <DataTrigger Binding="{Binding UpdateFailed}" Value="True">
                                        <Setter Property="Text" Value="Update Failed"/>
                                        <Setter Property="Foreground" Value="{StaticResource ErrorBrush}"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </TextBlock.Style>
                    </TextBlock>

                    <!-- Version transition -->
                    <TextBlock Text="{Binding UpdateTitle}"
                               FontSize="14"
                               Foreground="{StaticResource TextBrush}"
                               Margin="0,0,0,10"/>

                    <!-- Release notes (if any) -->
                    <Border Background="{StaticResource BackgroundBrush}"
                            CornerRadius="6" BorderBrush="{StaticResource BorderBrush}"
                            BorderThickness="1" Padding="10"
                            MaxHeight="160"
                            Margin="0,0,0,14"
                            Visibility="{Binding UpdateReleaseNotes, Converter={StaticResource BoolToVis}}">
                        <ScrollViewer VerticalScrollBarVisibility="Auto">
                            <TextBlock Text="{Binding UpdateReleaseNotes}"
                                       FontSize="12"
                                       Foreground="{StaticResource TextSecondaryBrush}"
                                       TextWrapping="Wrap"/>
                        </ScrollViewer>
                    </Border>

                    <!-- Progress bar (visible during download) -->
                    <ProgressBar Minimum="0" Maximum="100"
                                 Value="{Binding UpdateProgressPercent, Mode=OneWay}"
                                 Height="8"
                                 Margin="0,0,0,12"
                                 Foreground="{StaticResource PrimaryBrush}"
                                 Background="{StaticResource BackgroundBrush}"
                                 BorderThickness="0"
                                 Visibility="{Binding UpdateDownloading, Converter={StaticResource BoolToVis}}"/>

                    <!-- Status indicator -->
                    <StackPanel Orientation="Horizontal" Margin="0,0,0,12">
                        <TextBlock x:Name="UpdateStatusDot" Text="&#x25CF; " FontSize="16"
                                   Foreground="{StaticResource PrimaryBrush}"
                                   VerticalAlignment="Center">
                            <TextBlock.Style>
                                <Style TargetType="TextBlock">
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding UpdateDownloading}" Value="True">
                                            <DataTrigger.EnterActions>
                                                <BeginStoryboard x:Name="UpdatePulse">
                                                    <Storyboard RepeatBehavior="Forever">
                                                        <DoubleAnimation Storyboard.TargetProperty="Opacity"
                                                                         From="1.0" To="0.3"
                                                                         Duration="0:0:0.8"
                                                                         AutoReverse="True"/>
                                                    </Storyboard>
                                                </BeginStoryboard>
                                            </DataTrigger.EnterActions>
                                            <DataTrigger.ExitActions>
                                                <StopStoryboard BeginStoryboardName="UpdatePulse"/>
                                            </DataTrigger.ExitActions>
                                        </DataTrigger>
                                        <DataTrigger Binding="{Binding UpdateFailed}" Value="True">
                                            <Setter Property="Foreground" Value="{StaticResource ErrorBrush}"/>
                                            <Setter Property="Opacity" Value="1.0"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </TextBlock.Style>
                        </TextBlock>
                        <TextBlock Text="{Binding UpdateStatusText}"
                                   FontSize="13"
                                   Foreground="{StaticResource TextBrush}"
                                   VerticalAlignment="Center"
                                   TextWrapping="Wrap"/>
                    </StackPanel>

                    <!-- Warning: don't close (visible during download) -->
                    <TextBlock Text="&#x26A0; Please do not close the application during the update."
                               FontSize="11" FontStyle="Italic"
                               Foreground="#FFE0A0"
                               HorizontalAlignment="Center"
                               Margin="0,0,0,12"
                               Visibility="{Binding UpdateDownloading, Converter={StaticResource BoolToVis}}"/>

                    <!-- Buttons: Install / Later (before download starts) -->
                    <StackPanel Orientation="Horizontal"
                                HorizontalAlignment="Center"
                                Margin="0,4,0,0"
                                Visibility="{Binding UpdateDownloading, Converter={StaticResource BoolToVis}, ConverterParameter=Invert}">
                        <!-- Hide buttons when failed too -->
                        <StackPanel.Style>
                            <Style TargetType="StackPanel">
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding UpdateFailed}" Value="True">
                                        <Setter Property="Visibility" Value="Collapsed"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </StackPanel.Style>
                        <Button Content="Install Now"
                                Padding="24,8" Margin="0,0,12,0"
                                Click="UpdateInstall_Click">
                            <Button.Style>
                                <Style TargetType="Button">
                                    <Setter Property="Background" Value="{StaticResource PrimaryBrush}"/>
                                    <Setter Property="Foreground" Value="{StaticResource BackgroundBrush}"/>
                                    <Setter Property="BorderThickness" Value="0"/>
                                    <Setter Property="FontSize" Value="13"/>
                                    <Setter Property="FontWeight" Value="SemiBold"/>
                                    <Setter Property="Cursor" Value="Hand"/>
                                    <Setter Property="Template">
                                        <Setter.Value>
                                            <ControlTemplate TargetType="Button">
                                                <Border Background="{TemplateBinding Background}"
                                                        CornerRadius="6"
                                                        Padding="{TemplateBinding Padding}">
                                                    <ContentPresenter HorizontalAlignment="Center"
                                                                      VerticalAlignment="Center"/>
                                                </Border>
                                                <ControlTemplate.Triggers>
                                                    <Trigger Property="IsMouseOver" Value="True">
                                                        <Setter Property="Background" Value="#5CBF64"/>
                                                    </Trigger>
                                                </ControlTemplate.Triggers>
                                            </ControlTemplate>
                                        </Setter.Value>
                                    </Setter>
                                </Style>
                            </Button.Style>
                        </Button>
                        <Button Content="Later"
                                Padding="24,8"
                                Click="UpdateLater_Click">
                            <Button.Style>
                                <Style TargetType="Button">
                                    <Setter Property="Background" Value="{StaticResource SurfaceLightBrush}"/>
                                    <Setter Property="Foreground" Value="{StaticResource TextBrush}"/>
                                    <Setter Property="BorderBrush" Value="{StaticResource BorderBrush}"/>
                                    <Setter Property="BorderThickness" Value="1"/>
                                    <Setter Property="FontSize" Value="13"/>
                                    <Setter Property="Cursor" Value="Hand"/>
                                    <Setter Property="Template">
                                        <Setter.Value>
                                            <ControlTemplate TargetType="Button">
                                                <Border Background="{TemplateBinding Background}"
                                                        BorderBrush="{TemplateBinding BorderBrush}"
                                                        BorderThickness="{TemplateBinding BorderThickness}"
                                                        CornerRadius="6"
                                                        Padding="{TemplateBinding Padding}">
                                                    <ContentPresenter HorizontalAlignment="Center"
                                                                      VerticalAlignment="Center"/>
                                                </Border>
                                                <ControlTemplate.Triggers>
                                                    <Trigger Property="IsMouseOver" Value="True">
                                                        <Setter Property="Background"
                                                                Value="{StaticResource PrimaryBrush}"/>
                                                        <Setter Property="Foreground"
                                                                Value="{StaticResource BackgroundBrush}"/>
                                                    </Trigger>
                                                </ControlTemplate.Triggers>
                                            </ControlTemplate>
                                        </Setter.Value>
                                    </Setter>
                                </Style>
                            </Button.Style>
                        </Button>
                    </StackPanel>

                    <!-- Close button (only visible on failure) -->
                    <Button Content="Close"
                            Padding="24,8"
                            HorizontalAlignment="Center"
                            Margin="0,4,0,0"
                            Click="UpdateClose_Click"
                            Visibility="{Binding UpdateFailed, Converter={StaticResource BoolToVis}}">
                        <Button.Style>
                            <Style TargetType="Button">
                                <Setter Property="Background" Value="{StaticResource SurfaceLightBrush}"/>
                                <Setter Property="Foreground" Value="{StaticResource TextBrush}"/>
                                <Setter Property="BorderBrush" Value="{StaticResource BorderBrush}"/>
                                <Setter Property="BorderThickness" Value="1"/>
                                <Setter Property="FontSize" Value="13"/>
                                <Setter Property="Cursor" Value="Hand"/>
                                <Setter Property="Template">
                                    <Setter.Value>
                                        <ControlTemplate TargetType="Button">
                                            <Border Background="{TemplateBinding Background}"
                                                    BorderBrush="{TemplateBinding BorderBrush}"
                                                    BorderThickness="{TemplateBinding BorderThickness}"
                                                    CornerRadius="6"
                                                    Padding="{TemplateBinding Padding}">
                                                <ContentPresenter HorizontalAlignment="Center"
                                                                  VerticalAlignment="Center"/>
                                            </Border>
                                            <ControlTemplate.Triggers>
                                                <Trigger Property="IsMouseOver" Value="True">
                                                    <Setter Property="Background"
                                                            Value="{StaticResource PrimaryBrush}"/>
                                                    <Setter Property="Foreground"
                                                            Value="{StaticResource BackgroundBrush}"/>
                                                </Trigger>
                                            </ControlTemplate.Triggers>
                                        </ControlTemplate>
                                    </Setter.Value>
                                </Setter>
                            </Style>
                        </Button.Style>
                    </Button>
                </StackPanel>
            </Border>
        </Border>

        <!-- Dependency install overlay (covers entire window during setup) -->
        <Border Grid.Row="0" Grid.RowSpan="8"
                Background="#DD1e1e2e"
                Panel.ZIndex="100"
                Visibility="{Binding ShowDependencyOverlay, Converter={StaticResource BoolToVis}}">
            <Border HorizontalAlignment="Center" VerticalAlignment="Center"
                    Background="{StaticResource SurfaceBrush}"
                    CornerRadius="12" Padding="32"
                    Width="520"
                    BorderBrush="{StaticResource BorderBrush}"
                    BorderThickness="1">
                <StackPanel>
                    <!-- Step counter -->
                    <TextBlock Text="{Binding DependencyStep}"
                               FontSize="11" FontWeight="SemiBold"
                               Foreground="{StaticResource TextSecondaryBrush}"
                               Margin="0,0,0,4"/>

                    <!-- Title -->
                    <TextBlock Text="{Binding DependencyTitle}"
                               FontSize="18" FontWeight="Bold"
                               Foreground="{StaticResource PrimaryBrush}"
                               Margin="0,0,0,6"/>

                    <!-- Subtitle / description -->
                    <TextBlock Text="{Binding DependencySubtitle}"
                               FontSize="12"
                               Foreground="{StaticResource TextSecondaryBrush}"
                               TextWrapping="Wrap"
                               Margin="0,0,0,14"/>

                    <!-- Status indicator -->
                    <StackPanel Orientation="Horizontal" Margin="0,0,0,12">
                        <TextBlock x:Name="DepStatusDot" Text="&#x25CF; " FontSize="16"
                                   Foreground="{StaticResource PrimaryBrush}"
                                   VerticalAlignment="Center">
                            <TextBlock.Style>
                                <Style TargetType="TextBlock">
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding ShowDependencyOverlay}" Value="True">
                                            <DataTrigger.EnterActions>
                                                <BeginStoryboard x:Name="DepPulse">
                                                    <Storyboard RepeatBehavior="Forever">
                                                        <DoubleAnimation Storyboard.TargetProperty="Opacity"
                                                                         From="1.0" To="0.3"
                                                                         Duration="0:0:0.8"
                                                                         AutoReverse="True"/>
                                                    </Storyboard>
                                                </BeginStoryboard>
                                            </DataTrigger.EnterActions>
                                            <DataTrigger.ExitActions>
                                                <StopStoryboard BeginStoryboardName="DepPulse"/>
                                            </DataTrigger.ExitActions>
                                        </DataTrigger>
                                        <DataTrigger Binding="{Binding DependencyFailed}" Value="True">
                                            <Setter Property="Foreground" Value="{StaticResource ErrorBrush}"/>
                                            <Setter Property="Opacity" Value="1.0"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </TextBlock.Style>
                        </TextBlock>
                        <TextBlock Text="{Binding DependencyStatus}"
                                   FontSize="13"
                                   Foreground="{StaticResource TextBrush}"
                                   VerticalAlignment="Center"/>
                    </StackPanel>

                    <!-- Log output -->
                    <Border Background="{StaticResource BackgroundBrush}"
                            CornerRadius="6" BorderBrush="{StaticResource BorderBrush}"
                            BorderThickness="1" Padding="8"
                            Height="200">
                        <ScrollViewer x:Name="DepLogScroller" VerticalScrollBarVisibility="Auto">
                            <TextBlock x:Name="DepLogText"
                                       Text="{Binding DependencyLog}"
                                       FontFamily="Cascadia Code,Consolas,Courier New"
                                       FontSize="11"
                                       Foreground="{StaticResource TextSecondaryBrush}"
                                       TextWrapping="Wrap"/>
                        </ScrollViewer>
                    </Border>

                    <!-- Warning: don't close (hidden when failed) -->
                    <TextBlock Text="&#x26A0; Please do not close the application during installation."
                               FontSize="11" FontStyle="Italic"
                               Foreground="#FFE0A0"
                               HorizontalAlignment="Center"
                               Margin="0,10,0,0">
                        <TextBlock.Style>
                            <Style TargetType="TextBlock">
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding DependencyFailed}" Value="True">
                                        <Setter Property="Visibility" Value="Collapsed"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </TextBlock.Style>
                    </TextBlock>

                    <!-- Close button (only visible on failure) -->
                    <Button Content="Close"
                            Padding="24,8"
                            HorizontalAlignment="Center"
                            Margin="0,16,0,0"
                            Click="DepCloseButton_Click"
                            Visibility="{Binding DependencyFailed, Converter={StaticResource BoolToVis}}">
                        <Button.Style>
                            <Style TargetType="Button">
                                <Setter Property="Background" Value="{StaticResource SurfaceLightBrush}"/>
                                <Setter Property="Foreground" Value="{StaticResource TextBrush}"/>
                                <Setter Property="BorderBrush" Value="{StaticResource BorderBrush}"/>
                                <Setter Property="BorderThickness" Value="1"/>
                                <Setter Property="FontSize" Value="13"/>
                                <Setter Property="Cursor" Value="Hand"/>
                                <Setter Property="Template">
                                    <Setter.Value>
                                        <ControlTemplate TargetType="Button">
                                            <Border Background="{TemplateBinding Background}"
                                                    BorderBrush="{TemplateBinding BorderBrush}"
                                                    BorderThickness="{TemplateBinding BorderThickness}"
                                                    CornerRadius="6"
                                                    Padding="{TemplateBinding Padding}">
                                                <ContentPresenter HorizontalAlignment="Center"
                                                                  VerticalAlignment="Center"/>
                                            </Border>
                                            <ControlTemplate.Triggers>
                                                <Trigger Property="IsMouseOver" Value="True">
                                                    <Setter Property="Background"
                                                            Value="{StaticResource PrimaryBrush}"/>
                                                    <Setter Property="Foreground"
                                                            Value="{StaticResource BackgroundBrush}"/>
                                                </Trigger>
                                            </ControlTemplate.Triggers>
                                        </ControlTemplate>
                                    </Setter.Value>
                                </Setter>
                            </Style>
                        </Button.Style>
                    </Button>
                </StackPanel>
            </Border>
        </Border>

        <!-- Drag & drop overlay -->
        <Border x:Name="DragDropOverlay"
                Grid.Row="0" Grid.RowSpan="8"
                Background="#CC1e1e2e"
                Panel.ZIndex="200"
                Visibility="Collapsed"
                IsHitTestVisible="False">
            <Border HorizontalAlignment="Center" VerticalAlignment="Center"
                    Background="{StaticResource SurfaceBrush}"
                    CornerRadius="16" Padding="48,36"
                    BorderBrush="{StaticResource AccentBrush}"
                    BorderThickness="2">
                <StackPanel HorizontalAlignment="Center">
                    <TextBlock Text="&#x1F4CE;"
                               FontSize="40"
                               HorizontalAlignment="Center"
                               Margin="0,0,0,12"/>
                    <TextBlock Text="Drop files to attach"
                               FontSize="18" FontWeight="SemiBold"
                               Foreground="{StaticResource TextBrush}"
                               HorizontalAlignment="Center"/>
                    <TextBlock Text="Files will be sent with your next message"
                               FontSize="13"
                               Foreground="{StaticResource TextSecondaryBrush}"
                               HorizontalAlignment="Center"
                               Margin="0,6,0,0"/>
                </StackPanel>
            </Border>
        </Border>

    </Grid>
</Window>
