<Window x:Class="ClaudeCodeWin.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:converters="clr-namespace:ClaudeCodeWin.Converters"
        xmlns:vm="clr-namespace:ClaudeCodeWin.ViewModels"
        Title="ClaudeCodeWin"
        MinHeight="500" MinWidth="600"
        Background="{StaticResource BackgroundBrush}"
        AllowDrop="True"
        Drop="Window_Drop"
        DragOver="Window_DragOver"
        PreviewKeyDown="Window_PreviewKeyDown">

    <Window.Resources>
        <converters:BoolToVisibilityConverter x:Key="BoolToVis"/>
        <converters:InverseBoolConverter x:Key="InverseBool"/>
        <converters:RoleToAlignmentConverter x:Key="RoleToAlign"/>
        <converters:RoleToBubbleBrushConverter x:Key="RoleToBubble"/>
        <converters:RoleToMaxWidthConverter x:Key="RoleToMaxWidth"/>
    </Window.Resources>

    <Window.TaskbarItemInfo>
        <TaskbarItemInfo/>
    </Window.TaskbarItemInfo>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>     <!-- Menu -->
            <RowDefinition Height="*"/>        <!-- Chat -->
            <RowDefinition Height="Auto"/>     <!-- Message queue -->
            <RowDefinition Height="Auto"/>     <!-- Attachments -->
            <RowDefinition Height="Auto"/>     <!-- Input -->
            <RowDefinition Height="Auto"/>     <!-- Changed files -->
            <RowDefinition Height="Auto"/>     <!-- Status bar -->
        </Grid.RowDefinitions>

        <!-- Menu bar -->
        <Menu Grid.Row="0" Background="{StaticResource SurfaceBrush}">
            <MenuItem Header="_Session"
                      ToolTip="Session management: start new conversations, change project folder">
                <MenuItem Header="_New Session" Command="{Binding NewSessionCommand}"
                          InputGestureText="Ctrl+N"
                          ToolTip="Start a fresh conversation with Claude. Clears chat history and resets context.&#x0a;Example: Use after finishing one task to start a new unrelated task."/>
                <MenuItem Header="Change _Project Folder..." Command="{Binding SelectFolderCommand}"
                          ToolTip="Select a different project folder as Claude's working directory.&#x0a;Claude reads files, runs commands, and writes code relative to this folder.&#x0a;Example: Switch between ProjectA and ProjectB."/>
                <MenuItem Header="Chat _History..." Click="MenuItem_ChatHistory_Click"
                          ToolTip="Browse and reopen previous conversations."/>
                <MenuItem Header="Recent _Projects" x:Name="RecentProjectsMenu"
                          ToolTip="Recently opened project folders. Click to switch, use X to remove."/>
                <Separator/>
                <MenuItem Header="E_xit" Click="MenuItem_Exit_Click"
                          ToolTip="Close the application. Window position and size are saved automatically."/>
            </MenuItem>
            <MenuItem Header="S_cripts" x:Name="ScriptsMenu" Visibility="Collapsed"/>
            <MenuItem Header="_Tasks" x:Name="TasksMenu"
                      ToolTip="Shell commands: run predefined terminal commands in your project folder.&#x0a;Output appears in a separate window. Customize via tasks.json.&#x0a;Example: 'Git Status' runs 'git status' and displays the result."/>
            <MenuItem Header="_Help"
                      ToolTip="Updates and application information">
                <MenuItem Header="Check for _Updates..." Command="{Binding CheckForUpdatesCommand}"
                          ToolTip="Check if a newer version is available on the update server.&#x0a;If found, download and install with one click. Also checks automatically every 4 hours."/>
                <Separator/>
                <MenuItem Header="_About" Click="MenuItem_About_Click"
                          ToolTip="Application version, build date, and support contacts."/>
            </MenuItem>
        </Menu>

        <!-- Chat area -->
        <ScrollViewer Grid.Row="1" x:Name="ChatScrollViewer"
                      VerticalScrollBarVisibility="Auto"
                      Padding="12">
            <ItemsControl ItemsSource="{Binding Messages}" x:Name="MessagesControl">
                <ItemsControl.ItemTemplate>
                    <DataTemplate DataType="{x:Type vm:MessageViewModel}">
                        <StackPanel>
                            <!-- THINKING block — separate prominent rectangle -->
                            <Border Margin="4,4,4,4"
                                    Padding="16,12"
                                    CornerRadius="8"
                                    MinWidth="250"
                                    HorizontalAlignment="Left"
                                    Background="{StaticResource ThinkingBubbleBrush}"
                                    BorderBrush="{StaticResource PrimaryBrush}"
                                    BorderThickness="1"
                                    Visibility="{Binding IsThinking, Converter={StaticResource BoolToVis}}">
                                <Border.Triggers>
                                    <EventTrigger RoutedEvent="Loaded">
                                        <BeginStoryboard>
                                            <Storyboard RepeatBehavior="Forever">
                                                <DoubleAnimation Storyboard.TargetProperty="Opacity"
                                                                 From="1.0" To="0.6"
                                                                 Duration="0:0:0.8"
                                                                 AutoReverse="True"/>
                                            </Storyboard>
                                        </BeginStoryboard>
                                    </EventTrigger>
                                </Border.Triggers>
                                <StackPanel Orientation="Horizontal">
                                    <TextBlock Text="&#x25CF; " FontSize="18"
                                               Foreground="{StaticResource PrimaryBrush}"
                                               VerticalAlignment="Center"/>
                                    <TextBlock Text="Claude is thinking..."
                                               FontFamily="Segoe UI"
                                               FontSize="15"
                                               FontWeight="SemiBold"
                                               Foreground="{StaticResource PrimaryBrush}"
                                               VerticalAlignment="Center"/>
                                </StackPanel>
                            </Border>

                            <!-- Main message bubble -->
                            <Border Margin="4,4,4,4"
                                    Padding="12,8"
                                    CornerRadius="8"
                                    Background="{Binding Role, Converter={StaticResource RoleToBubble}}"
                                    HorizontalAlignment="{Binding Role, Converter={StaticResource RoleToAlign}}"
                                    MaxWidth="{Binding Role, Converter={StaticResource RoleToMaxWidth}}"
                                    Visibility="{Binding IsThinking, Converter={StaticResource BoolToVis}, ConverterParameter=Invert}">
                                <StackPanel>
                                    <!-- Main text (selectable) -->
                                    <TextBox Text="{Binding Text, Mode=OneWay}"
                                             IsReadOnly="True"
                                             TextWrapping="Wrap"
                                             FontFamily="Cascadia Code,Consolas,Courier New"
                                             FontSize="13.5"
                                             Background="Transparent"
                                             BorderThickness="0"
                                             Padding="0"
                                             Foreground="{StaticResource TextBrush}"
                                             SelectionBrush="{StaticResource SelectionBrush}"
                                             IsTabStop="False"
                                             Cursor="IBeam">
                                        <TextBox.ContextMenu>
                                            <ContextMenu>
                                                <MenuItem Header="Copy Selection" Command="ApplicationCommands.Copy"/>
                                                <MenuItem Header="Copy All" Click="CopyAllMessage_Click"
                                                          Tag="{Binding Text}"/>
                                            </ContextMenu>
                                        </TextBox.ContextMenu>
                                    </TextBox>

                                    <!-- Tool uses — compact summary with expandable details -->
                                    <Border Background="{StaticResource ToolBubbleBrush}"
                                            CornerRadius="4" Padding="6,4" Margin="0,6,0,0"
                                            Visibility="{Binding HasToolUses, Converter={StaticResource BoolToVis}}">
                                        <Expander IsExpanded="False"
                                                  Foreground="{StaticResource TextSecondaryBrush}">
                                            <Expander.Header>
                                                <StackPanel Orientation="Horizontal">
                                                    <TextBlock Text="&#x25CF; " FontSize="10"
                                                               Foreground="{StaticResource PrimaryBrush}"
                                                               VerticalAlignment="Center"/>
                                                    <TextBlock Text="{Binding ToolActivitySummary}"
                                                               FontSize="12"
                                                               Foreground="{StaticResource PrimaryBrush}"
                                                               VerticalAlignment="Center"/>
                                                </StackPanel>
                                            </Expander.Header>
                                            <ItemsControl ItemsSource="{Binding ToolUses}" Margin="4,4,0,0">
                                                <ItemsControl.ItemTemplate>
                                                    <DataTemplate DataType="{x:Type vm:ToolUseViewModel}">
                                                        <Border Margin="0,1" Padding="4,2"
                                                                CornerRadius="3">
                                                            <StackPanel>
                                                                <StackPanel Orientation="Horizontal" Cursor="Hand">
                                                                    <TextBlock FontSize="9" Margin="0,0,5,0"
                                                                               Foreground="{StaticResource PrimaryBrush}"
                                                                               VerticalAlignment="Center">
                                                                        <TextBlock.Style>
                                                                            <Style TargetType="TextBlock">
                                                                                <Setter Property="Text" Value="&#x25B6;"/>
                                                                                <Style.Triggers>
                                                                                    <DataTrigger Binding="{Binding IsExpanded}" Value="True">
                                                                                        <Setter Property="Text" Value="&#x25BC;"/>
                                                                                    </DataTrigger>
                                                                                </Style.Triggers>
                                                                            </Style>
                                                                        </TextBlock.Style>
                                                                    </TextBlock>
                                                                    <TextBlock Text="{Binding ToolName}"
                                                                               FontWeight="SemiBold"
                                                                               Foreground="{StaticResource PrimaryBrush}"
                                                                               FontSize="11.5"/>
                                                                    <TextBlock Text=": " FontSize="11.5"
                                                                               Foreground="{StaticResource TextSecondaryBrush}"
                                                                               Visibility="{Binding Summary, Converter={StaticResource BoolToVis}}"/>
                                                                    <TextBlock Text="{Binding Summary}"
                                                                               FontSize="11.5"
                                                                               Foreground="{StaticResource TextSecondaryBrush}"
                                                                               TextTrimming="CharacterEllipsis"
                                                                               MaxWidth="500"/>
                                                                    <StackPanel.InputBindings>
                                                                        <MouseBinding Gesture="LeftClick"
                                                                                      Command="{Binding ToggleExpandedCommand}"/>
                                                                    </StackPanel.InputBindings>
                                                                </StackPanel>
                                                                <!-- Expanded: show result preview -->
                                                                <TextBox Text="{Binding ResultPreview, Mode=OneWay}"
                                                                         IsReadOnly="True"
                                                                         TextWrapping="Wrap"
                                                                         FontFamily="Cascadia Code,Consolas,Courier New"
                                                                         FontSize="11"
                                                                         Background="Transparent"
                                                                         BorderThickness="0"
                                                                         Padding="0"
                                                                         Foreground="{StaticResource TextSecondaryBrush}"
                                                                         SelectionBrush="{StaticResource SelectionBrush}"
                                                                         IsTabStop="False"
                                                                         MaxHeight="200"
                                                                         VerticalScrollBarVisibility="Auto"
                                                                         Visibility="{Binding IsExpanded, Converter={StaticResource BoolToVis}}"
                                                                         Margin="16,3,0,2"/>
                                                            </StackPanel>
                                                        </Border>
                                                    </DataTemplate>
                                                </ItemsControl.ItemTemplate>
                                            </ItemsControl>
                                        </Expander>
                                    </Border>

                                    <!-- AskUserQuestion buttons -->
                                    <ItemsControl ItemsSource="{Binding QuestionDisplay.Options}"
                                                  Visibility="{Binding HasQuestion, Converter={StaticResource BoolToVis}}"
                                                  Margin="0,8,0,0">
                                        <ItemsControl.ItemsPanel>
                                            <ItemsPanelTemplate>
                                                <WrapPanel Orientation="Horizontal"/>
                                            </ItemsPanelTemplate>
                                        </ItemsControl.ItemsPanel>
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate>
                                                <Button Margin="0,0,6,4"
                                                        Padding="12,6"
                                                        Cursor="Hand"
                                                        Command="{Binding DataContext.AnswerQuestionCommand,
                                                            RelativeSource={RelativeSource AncestorType=Window}}"
                                                        CommandParameter="{Binding Label}"
                                                        ToolTip="{Binding Description}">
                                                    <Button.Style>
                                                        <Style TargetType="Button">
                                                            <Setter Property="Background" Value="{StaticResource SurfaceLightBrush}"/>
                                                            <Setter Property="Foreground" Value="{StaticResource PrimaryBrush}"/>
                                                            <Setter Property="BorderBrush" Value="{StaticResource PrimaryBrush}"/>
                                                            <Setter Property="BorderThickness" Value="1"/>
                                                            <Setter Property="FontSize" Value="12"/>
                                                            <Setter Property="FontWeight" Value="SemiBold"/>
                                                            <Setter Property="Template">
                                                                <Setter.Value>
                                                                    <ControlTemplate TargetType="Button">
                                                                        <Border Background="{TemplateBinding Background}"
                                                                                BorderBrush="{TemplateBinding BorderBrush}"
                                                                                BorderThickness="{TemplateBinding BorderThickness}"
                                                                                CornerRadius="6"
                                                                                Padding="{TemplateBinding Padding}">
                                                                            <ContentPresenter HorizontalAlignment="Center"
                                                                                              VerticalAlignment="Center"/>
                                                                        </Border>
                                                                        <ControlTemplate.Triggers>
                                                                            <Trigger Property="IsMouseOver" Value="True">
                                                                                <Setter Property="Background"
                                                                                        Value="{StaticResource PrimaryBrush}"/>
                                                                                <Setter Property="Foreground"
                                                                                        Value="{StaticResource BackgroundBrush}"/>
                                                                            </Trigger>
                                                                        </ControlTemplate.Triggers>
                                                                    </ControlTemplate>
                                                                </Setter.Value>
                                                            </Setter>
                                                        </Style>
                                                    </Button.Style>
                                                    <TextBlock Text="{Binding Label}"/>
                                                </Button>
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>

                                    <!-- Streaming indicator -->
                                    <TextBlock Text="&#x25CF;" FontSize="16"
                                               Foreground="{StaticResource PrimaryBrush}"
                                               Visibility="{Binding IsStreaming, Converter={StaticResource BoolToVis}}"
                                               Margin="0,4,0,0">
                                        <TextBlock.Triggers>
                                            <EventTrigger RoutedEvent="Loaded">
                                                <BeginStoryboard>
                                                    <Storyboard RepeatBehavior="Forever">
                                                        <DoubleAnimation Storyboard.TargetProperty="Opacity"
                                                                         From="1" To="0.2"
                                                                         Duration="0:0:0.6"
                                                                         AutoReverse="True"/>
                                                    </Storyboard>
                                                </BeginStoryboard>
                                            </EventTrigger>
                                        </TextBlock.Triggers>
                                    </TextBlock>
                                </StackPanel>
                            </Border>
                        </StackPanel>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
        </ScrollViewer>

        <!-- Welcome overlay -->
        <Border Grid.Row="1"
                Background="{StaticResource BackgroundBrush}"
                Visibility="{Binding ShowWelcome, Converter={StaticResource BoolToVis}}"
                Panel.ZIndex="10">
            <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center"
                        MaxWidth="500" Margin="40">
                <TextBlock Text="Welcome to ClaudeCodeWin!"
                           FontSize="24" FontWeight="Bold"
                           Foreground="{StaticResource PrimaryBrush}"
                           HorizontalAlignment="Center"
                           Margin="0,0,0,12"/>
                <TextBlock Text="Select a project folder to get started."
                           FontSize="14"
                           Foreground="{StaticResource TextSecondaryBrush}"
                           HorizontalAlignment="Center"
                           Margin="0,0,0,24"/>

                <Button Content="Browse..."
                        Style="{StaticResource PrimaryButton}"
                        Command="{Binding SelectFolderCommand}"
                        HorizontalAlignment="Center"
                        Margin="0,0,0,24"
                        Padding="32,10"/>

                <!-- Recent folders -->
                <TextBlock Text="Recent Projects"
                           FontSize="14" FontWeight="SemiBold"
                           Foreground="{StaticResource TextBrush}"
                           Margin="0,0,0,8"
                           Visibility="{Binding RecentFolders.Count, Converter={StaticResource BoolToVis}}"/>

                <ItemsControl ItemsSource="{Binding RecentFolders}"
                              Visibility="{Binding RecentFolders.Count, Converter={StaticResource BoolToVis}}">
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <Border Background="{StaticResource SurfaceBrush}"
                                    CornerRadius="6" Padding="12,8" Margin="0,0,0,4"
                                    Cursor="Hand">
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>

                                    <TextBlock Grid.Column="0" Text="{Binding}"
                                               FontSize="13"
                                               Foreground="{StaticResource TextBrush}"
                                               VerticalAlignment="Center"
                                               TextTrimming="CharacterEllipsis"/>

                                    <Button Grid.Column="1"
                                            Style="{StaticResource ChipCloseButton}"
                                            Command="{Binding DataContext.RemoveRecentFolderCommand,
                                                RelativeSource={RelativeSource AncestorType=Window}}"
                                            CommandParameter="{Binding}"
                                            Margin="8,0,0,0"/>
                                </Grid>

                                <Border.InputBindings>
                                    <MouseBinding Gesture="LeftClick"
                                                  Command="{Binding DataContext.OpenRecentFolderCommand,
                                                      RelativeSource={RelativeSource AncestorType=Window}}"
                                                  CommandParameter="{Binding}"/>
                                </Border.InputBindings>

                                <Border.Style>
                                    <Style TargetType="Border">
                                        <Style.Triggers>
                                            <Trigger Property="IsMouseOver" Value="True">
                                                <Setter Property="Background" Value="{StaticResource SurfaceLightBrush}"/>
                                            </Trigger>
                                        </Style.Triggers>
                                    </Style>
                                </Border.Style>
                            </Border>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </StackPanel>
        </Border>

        <!-- Message queue -->
        <Border Grid.Row="2"
                Background="{StaticResource SurfaceBrush}"
                Padding="8,4"
                Visibility="{Binding HasQueuedMessages, Converter={StaticResource BoolToVis}}"
                BorderBrush="{StaticResource BorderBrush}"
                BorderThickness="0,1,0,0">
            <StackPanel>
                <TextBlock Text="Queued messages:" FontSize="11" FontWeight="SemiBold"
                           Foreground="{StaticResource TextSecondaryBrush}" Margin="4,0,0,4"/>
                <ItemsControl ItemsSource="{Binding MessageQueue}">
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <Border Background="{StaticResource SurfaceLightBrush}"
                                    CornerRadius="4" Padding="8,4" Margin="0,0,0,3">
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Grid.Column="0" Text="&#x23F3;" FontSize="11"
                                               Foreground="{StaticResource TextSecondaryBrush}"
                                               VerticalAlignment="Center" Margin="0,0,6,0"/>
                                    <TextBlock Grid.Column="1" Text="{Binding Text}"
                                               FontSize="12" TextTrimming="CharacterEllipsis"
                                               Foreground="{StaticResource TextBrush}"
                                               VerticalAlignment="Center"/>
                                    <!-- Send now: cancel current + send this -->
                                    <Border Grid.Column="2" Cursor="Hand" Background="Transparent"
                                            Margin="4,0,0,0" ToolTip="Send now (cancel current task)">
                                        <Border.InputBindings>
                                            <MouseBinding Gesture="LeftClick"
                                                          Command="{Binding DataContext.SendQueuedNowCommand,
                                                              RelativeSource={RelativeSource AncestorType=Window}}"
                                                          CommandParameter="{Binding}"/>
                                        </Border.InputBindings>
                                        <TextBlock Text="&#x25B6;" FontSize="10"
                                                   Foreground="{StaticResource SuccessBrush}"
                                                   VerticalAlignment="Center" Padding="2,0"/>
                                    </Border>
                                    <!-- Return to input textbox -->
                                    <Border Grid.Column="3" Cursor="Hand" Background="Transparent"
                                            Margin="4,0,0,0" ToolTip="Return to input (edit message)">
                                        <Border.InputBindings>
                                            <MouseBinding Gesture="LeftClick"
                                                          Command="{Binding DataContext.ReturnQueuedToInputCommand,
                                                              RelativeSource={RelativeSource AncestorType=Window}}"
                                                          CommandParameter="{Binding}"/>
                                        </Border.InputBindings>
                                        <TextBlock Text="&#x21A9;" FontSize="12"
                                                   Foreground="{StaticResource PrimaryBrush}"
                                                   VerticalAlignment="Center" Padding="2,0"/>
                                    </Border>
                                    <!-- Delete from queue -->
                                    <Button Grid.Column="4" Style="{StaticResource ChipCloseButton}"
                                            Command="{Binding DataContext.RemoveQueuedMessageCommand,
                                                RelativeSource={RelativeSource AncestorType=Window}}"
                                            CommandParameter="{Binding}"
                                            ToolTip="Remove from queue"/>
                                </Grid>
                            </Border>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </StackPanel>
        </Border>

        <!-- Attachments bar -->
        <Border Grid.Row="3"
                Background="{StaticResource SurfaceBrush}"
                Padding="8,4"
                Visibility="{Binding HasAttachments, Converter={StaticResource BoolToVis}}"
                x:Name="AttachmentBar">
            <ItemsControl ItemsSource="{Binding Attachments}">
                <ItemsControl.ItemsPanel>
                    <ItemsPanelTemplate>
                        <WrapPanel Orientation="Horizontal"/>
                    </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>
                <ItemsControl.ItemTemplate>
                    <DataTemplate>
                        <Border Style="{StaticResource ChipBorder}">
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="{Binding FileTypeIcon}" FontSize="12" Margin="0,0,4,0"
                                           VerticalAlignment="Center"/>
                                <TextBlock Text="{Binding FileName}"
                                           FontSize="12"
                                           Foreground="{StaticResource TextBrush}"
                                           VerticalAlignment="Center"/>
                                <!-- Preview button for images -->
                                <Button Content="&#x1F441;" FontSize="11" Padding="4,0"
                                        Margin="4,0,0,0" Cursor="Hand"
                                        VerticalAlignment="Center"
                                        Visibility="{Binding IsImage, Converter={StaticResource BoolToVis}}"
                                        Command="{Binding DataContext.PreviewAttachmentCommand,
                                            RelativeSource={RelativeSource AncestorType=Window}}"
                                        CommandParameter="{Binding}"
                                        ToolTip="Preview image">
                                    <Button.Style>
                                        <Style TargetType="Button">
                                            <Setter Property="Background" Value="Transparent"/>
                                            <Setter Property="BorderThickness" Value="0"/>
                                            <Setter Property="Template">
                                                <Setter.Value>
                                                    <ControlTemplate TargetType="Button">
                                                        <Border Background="Transparent" Padding="{TemplateBinding Padding}">
                                                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                                        </Border>
                                                    </ControlTemplate>
                                                </Setter.Value>
                                            </Setter>
                                        </Style>
                                    </Button.Style>
                                </Button>
                                <Button Style="{StaticResource ChipCloseButton}"
                                        Command="{Binding DataContext.RemoveAttachmentCommand,
                                            RelativeSource={RelativeSource AncestorType=Window}}"
                                        CommandParameter="{Binding}"/>
                            </StackPanel>
                        </Border>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
        </Border>

        <!-- Input area -->
        <Grid Grid.Row="4" Margin="8">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>

            <Grid Grid.Column="0">
                <TextBox x:Name="InputTextBox"
                         Style="{StaticResource InputTextBox}"
                         Text="{Binding InputText, UpdateSourceTrigger=PropertyChanged}"
                         MaxHeight="200"
                         MinHeight="40"
                         VerticalAlignment="Stretch"/>
                <!-- Placeholder text -->
                <TextBlock Text="Type your message here... (Enter to send, Shift+Enter for newline)"
                           IsHitTestVisible="False"
                           Foreground="{StaticResource TextSecondaryBrush}"
                           FontFamily="Cascadia Code,Consolas,Courier New"
                           FontSize="13"
                           FontStyle="Italic"
                           Margin="12,10,0,0"
                           VerticalAlignment="Top">
                    <TextBlock.Style>
                        <Style TargetType="TextBlock" BasedOn="{StaticResource {x:Type TextBlock}}">
                            <Setter Property="Visibility" Value="Collapsed"/>
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding InputText}" Value="">
                                    <Setter Property="Visibility" Value="Visible"/>
                                </DataTrigger>
                                <DataTrigger Binding="{Binding InputText}" Value="{x:Null}">
                                    <Setter Property="Visibility" Value="Visible"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </TextBlock.Style>
                </TextBlock>

                <!-- Autocomplete popup -->
                <Popup x:Name="AutocompletePopup"
                       PlacementTarget="{Binding ElementName=InputTextBox}"
                       Placement="Top"
                       StaysOpen="False"
                       AllowsTransparency="True"
                       PopupAnimation="Fade"
                       MaxHeight="280">
                    <Border Background="{StaticResource SurfaceBrush}"
                            BorderBrush="{StaticResource BorderBrush}"
                            BorderThickness="1"
                            CornerRadius="4"
                            Padding="0,4">
                        <ListBox x:Name="AutocompleteList"
                                 Background="Transparent"
                                 BorderThickness="0"
                                 Foreground="{StaticResource TextBrush}"
                                 FontFamily="Cascadia Code,Consolas,Courier New"
                                 FontSize="13"
                                 MaxHeight="260"
                                 ScrollViewer.HorizontalScrollBarVisibility="Disabled">
                            <ListBox.ItemContainerStyle>
                                <Style TargetType="ListBoxItem">
                                    <Setter Property="Foreground" Value="{StaticResource TextBrush}"/>
                                    <Setter Property="Padding" Value="8,4"/>
                                    <Setter Property="Cursor" Value="Hand"/>
                                    <Setter Property="Template">
                                        <Setter.Value>
                                            <ControlTemplate TargetType="ListBoxItem">
                                                <Border x:Name="Bd" Background="Transparent" Padding="8,4">
                                                    <ContentPresenter/>
                                                </Border>
                                                <ControlTemplate.Triggers>
                                                    <Trigger Property="IsSelected" Value="True">
                                                        <Setter TargetName="Bd" Property="Background"
                                                                Value="{StaticResource MenuHighlightBrush}"/>
                                                    </Trigger>
                                                    <Trigger Property="IsMouseOver" Value="True">
                                                        <Setter TargetName="Bd" Property="Background"
                                                                Value="{StaticResource SurfaceLightBrush}"/>
                                                    </Trigger>
                                                </ControlTemplate.Triggers>
                                            </ControlTemplate>
                                        </Setter.Value>
                                    </Setter>
                                </Style>
                            </ListBox.ItemContainerStyle>
                        </ListBox>
                    </Border>
                </Popup>
            </Grid>

            <StackPanel Grid.Column="1" Margin="8,0,0,0" VerticalAlignment="Bottom">
                <Button Style="{StaticResource PrimaryButton}"
                        Command="{Binding SendCommand}"
                        Margin="0,0,0,4">
                    <Button.Content>
                        <TextBlock>
                            <TextBlock.Style>
                                <Style TargetType="TextBlock">
                                    <Setter Property="Text" Value="Send"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding IsProcessing}" Value="True">
                                            <Setter Property="Text" Value="Queue"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </TextBlock.Style>
                        </TextBlock>
                    </Button.Content>
                </Button>
                <Button Content="Cancel"
                        Style="{StaticResource CancelButton}"
                        Command="{Binding CancelCommand}"
                        Visibility="{Binding IsProcessing, Converter={StaticResource BoolToVis}}"/>
            </StackPanel>
        </Grid>

        <!-- Changed files indicator -->
        <Border Grid.Row="5"
                Background="{StaticResource SurfaceBrush}"
                Padding="8,3"
                Visibility="{Binding HasChangedFiles, Converter={StaticResource BoolToVis}}"
                BorderBrush="{StaticResource BorderBrush}"
                BorderThickness="0,1,0,0">
            <Expander IsExpanded="False" Foreground="{StaticResource TextSecondaryBrush}">
                <Expander.Header>
                    <TextBlock Text="{Binding ChangedFilesText}" FontSize="11"
                               Foreground="{StaticResource AccentBrush}"/>
                </Expander.Header>
                <ItemsControl ItemsSource="{Binding ChangedFiles}" Margin="16,2,0,2">
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <Border Cursor="Hand" Background="Transparent"
                                    Margin="0,1" Padding="2,1"
                                    ToolTip="Click to view changes">
                                <Border.InputBindings>
                                    <MouseBinding Gesture="LeftClick"
                                                  Command="{Binding DataContext.ViewChangedFileCommand,
                                                      RelativeSource={RelativeSource AncestorType=Window}}"
                                                  CommandParameter="{Binding}"/>
                                </Border.InputBindings>
                                <TextBlock Text="{Binding}" FontSize="11"
                                           FontFamily="Cascadia Code,Consolas,Courier New"
                                           Foreground="{StaticResource PrimaryBrush}"
                                           TextDecorations="Underline"/>
                                <Border.Style>
                                    <Style TargetType="Border">
                                        <Style.Triggers>
                                            <Trigger Property="IsMouseOver" Value="True">
                                                <Setter Property="Background"
                                                        Value="{StaticResource SurfaceLightBrush}"/>
                                            </Trigger>
                                        </Style.Triggers>
                                    </Style>
                                </Border.Style>
                            </Border>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </Expander>
        </Border>

        <!-- Status bar -->
        <Border Grid.Row="6" Style="{StaticResource StatusBarStyle}">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="8"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <TextBlock Grid.Column="0" Text="{Binding StatusText}"
                           FontSize="12" Foreground="{StaticResource TextSecondaryBrush}"
                           VerticalAlignment="Center"/>
                <TextBlock Grid.Column="2" Text="{Binding ProjectPath}"
                           FontSize="11" Foreground="{StaticResource TextSecondaryBrush}"
                           VerticalAlignment="Center"
                           TextTrimming="CharacterEllipsis"
                           Opacity="0.7"
                           Margin="0,0,16,0"/>
                <TextBlock Grid.Column="3" Text="{Binding GitStatusText}"
                           FontSize="12" Foreground="{StaticResource AccentBrush}"
                           VerticalAlignment="Center" Margin="0,0,16,0"/>
                <Border Grid.Column="4" VerticalAlignment="Center" Margin="0,0,16,0"
                        Cursor="Hand" Background="Transparent"
                        MouseLeftButtonUp="MemoryIndicator_Click"
                        ToolTip="Click to open session menu">
                    <StackPanel Orientation="Horizontal">
                        <TextBlock Text="{Binding TokenUsageText}"
                                   FontSize="11" Foreground="{StaticResource TextSecondaryBrush}"
                                   VerticalAlignment="Center"/>
                        <TextBlock Text=" &#x25BC;" FontSize="7"
                                   Foreground="{StaticResource TextSecondaryBrush}"
                                   VerticalAlignment="Center" Margin="2,1,0,0"/>
                    </StackPanel>
                    <Border.ContextMenu>
                        <ContextMenu x:Name="MemoryContextMenu">
                            <MenuItem Header="New Session" Command="{Binding NewSessionCommand}"
                                      InputGestureText="Ctrl+N"
                                      ToolTip="Start a fresh conversation. Clears history and resets memory usage."/>
                        </ContextMenu>
                    </Border.ContextMenu>
                </Border>
                <TextBlock Grid.Column="5" Text="{Binding ModelName}"
                           FontSize="12" Foreground="{StaticResource PrimaryBrush}"
                           VerticalAlignment="Center"/>
            </Grid>
        </Border>
    </Grid>
</Window>
